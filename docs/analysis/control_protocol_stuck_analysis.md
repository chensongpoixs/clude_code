# Agent 决策链路异常：控制协议“鬼打墙”现象分析报告

## 1. 现象描述 (Symptoms)
用户在进行连续天气查询（北京 -> 南京 -> 淮安）后，Agent 开始在每一轮请求中重复输出：
`{"control": "step_done"}\n\n{"control": "step_done"}`
且控制台日志显示 `✓ LLM 返回最终回复（无工具调用）`，用户无法获得自然的语言总结。

---

## 2. 根因分析 (Root Causes)

### A. 指令集过度约束 (Instruction Over-constraint)
在 `prompts.py` 中，我们设置了两条相互竞争的高优先级规则：
1. **[全局结构]**: 要求每一轮必须包含 `一、思路分析` 和 `二、工具调用`。
2. **[控制协议]**: 要求完成时 `必须且只能` 输出一个控制 JSON。
**结果**: 当模型认为任务结束时，它为了遵守“只能输出 JSON”，强行阉割了“思路分析”，又因为历史上下文中存在多个 `step_done`，它产生了输出镜像。

### B. 场景识别失效 (Context Confusion)
- **预期**: `step_done` 仅用于 `Planner` 的步骤流转。
- **现状**: 模型在简单的 `ReAct` 场景（无需规划的任务）中也应用了该规则。
- **后果**: 模型认为“展示完天气后我必须按规则 6 闭嘴”，导致用户看到的直接输出是协议字符串。

### C. 资源参数干扰 (Parameter Issue)
- `max_tokens: 409600` 导致模型在生成 JSON 后的剩余“能量”过多，倾向于填充更多内容，导致了双重 JSON 的出现。

---

## 3. 解决方案 (Proposed Solutions)

### 方案一：动态 Prompt 注入（分场景隔离）
- **思路**: 修改 `prompts.py`，将控制协议规则改为“仅在执行多步计划时生效”。对于常规对话或 ReAct 决策，不注入该强制规则。
- **动作**: 
    - 在 `AgentLoop` 中增加一个状态标志位 `is_executing_plan`。
    - 仅在 `is_executing_plan=True` 时，向系统提示词注入关于 `step_done` 的强约束。

### 方案二：控制协议语义降级
- **思路**: 允许模型在输出 `step_done` 的同时，附带一段面向用户的“最终总结”。
- **动作**: 
    - 修改控制协议模型，增加一个可选字段：`{"control": "step_done", "summary": "这是给用户的最终回答"}`。
    - 这样即使模型执行了协议，用户依然能看到内容。

### 方案三：强化 LLM 响应解析逻辑
- **思路**: 增强对多重 JSON 和协议异常的容错。
- **动作**:
    - 如果响应中包含 `control` 信号，强制拦截并进行内部流转，不将其作为 `assistant_text` 展示给用户。
    - 如果 `assistant_text` 为空或仅包含协议 JSON，则自动提取上一次 `display` 工具的内容作为回答。

---

## 4. 下一步行动计划 (Action Plan)

1. [ ] **Prompt 重构**: 将“任务输出结构”与“控制协议”进行逻辑解耦。
2. [ ] **状态机优化**: 在 `AgentLoop` 中明确区分 `CHAT_MODE` 和 `PLAN_MODE`。
3. [ ] **解析器升级**: 实现 `extract_first_json_and_ignore_rest` 策略。
4. [ ] **配置修正**: 确保运行时 `max_tokens` 被硬硬截断在 2048 以内。

