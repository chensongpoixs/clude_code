# P0-1: ç¼“å­˜ç»†ç²’åº¦å¤±æ•ˆå®ç°

> **çŠ¶æ€**: ğŸ”„ è¿›è¡Œä¸­  
> **å¼€å§‹æ—¶é—´**: 2026-01-23

---

## 1. é—®é¢˜åˆ†æ

### 1.1 å½“å‰è¡Œä¸º
```python
# tool_dispatch.py L1336-1337
if name in {"write_file", "apply_patch", "undo_patch"} and tr.ok:
    cache.clear()  # â† æ¸…ç©ºæ‰€æœ‰ç¼“å­˜
```

### 1.2 é—®é¢˜
- ç¼–è¾‘æ–‡ä»¶ A åï¼Œæ–‡ä»¶ Bã€Cã€D çš„è¯»å–ç¼“å­˜ä¹Ÿè¢«æ¸…ç©ºã€‚
- åœ¨å¤šæ–‡ä»¶ç¼–è¾‘ä»»åŠ¡ä¸­ï¼Œç¼“å­˜å‘½ä¸­ç‡éª¤é™ä¸º 0ã€‚
- è¿èƒŒ"æœ€å°å¿…è¦"åŸåˆ™ã€‚

### 1.3 ä¸šç•Œå¯¹æ ‡
| ç³»ç»Ÿ | ç­–ç•¥ |
| :--- | :--- |
| VSCode | ç›‘å¬æ–‡ä»¶ç³»ç»Ÿäº‹ä»¶ï¼Œåªå¤±æ•ˆå˜æ›´æ–‡ä»¶ |
| Cursor | path-aware å¤±æ•ˆ |
| Browser Cache | URL/è·¯å¾„ç²’åº¦çš„ ETag æ ¡éªŒ |

---

## 2. è®¾è®¡æ–¹æ¡ˆ

### 2.1 æŠ€æœ¯è·¯çº¿
1. ä»å†™æ“ä½œçš„ `ToolResult.payload` ä¸­æå–è¢«ä¿®æ”¹çš„è·¯å¾„ã€‚
2. è°ƒç”¨ `cache.invalidate_path(path)` è€Œé `cache.clear()`ã€‚
3. åŒæ—¶å¤±æ•ˆ"çˆ¶ç›®å½•"ç›¸å…³çš„ `list_dir` ç¼“å­˜ï¼ˆå› ä¸ºç›®å½•å†…å®¹å¯èƒ½å˜åŒ–ï¼‰ã€‚

### 2.2 è·¯å¾„æå–è§„åˆ™
| å·¥å…· | payload ä¸­çš„è·¯å¾„å­—æ®µ |
| :--- | :--- |
| `write_file` | `payload["path"]` |
| `apply_patch` | `payload["path"]` |
| `undo_patch` | `payload["path"]` |

### 2.3 å¢å¼º `invalidate_path` 
å½“å‰ `invalidate_path` åªåŒ¹é…ç»“æœä¸­çš„ `path/file` å­—æ®µã€‚éœ€è¦å¢å¼ºä»¥æ”¯æŒï¼š
- ç²¾å‡†åŒ¹é…ï¼š`path == target` æˆ– `path.endswith(target)`
- çˆ¶ç›®å½•åŒ¹é…ï¼šå¦‚æœ `target` æ˜¯ `src/main.py`ï¼Œåˆ™ `list_dir(path="src")` çš„ç¼“å­˜ä¹Ÿåº”å¤±æ•ˆã€‚

---

## 3. å®ç°æ­¥éª¤

- [x] 3.1 å¢å¼º `ToolResultCache.invalidate_path` æ”¯æŒçˆ¶ç›®å½•å¤±æ•ˆ
- [x] 3.2 ä¿®æ”¹ `dispatch_tool` ä½¿ç”¨ `invalidate_path` æ›¿ä»£ `clear`
- [x] 3.3 ç¼–è¯‘æ£€æŸ¥ âœ… é€šè¿‡
- [x] 3.4 éªŒè¯æ±‡æŠ¥ âœ… å®Œæˆ

---

## 5. éªŒè¯ç»“æœ

### 5.1 ç¼–è¯‘æ£€æŸ¥
```
python -m compileall -q tool_result_cache.py tool_dispatch.py
# Exit code: 0 âœ…
```

### 5.2 æ ¸å¿ƒå˜æ›´æ‘˜è¦

**`tool_result_cache.py` - `invalidate_path` å¢å¼º**:
- ç­–ç•¥ 1: ç²¾å‡†åŒ¹é…ï¼ˆæ–‡ä»¶è·¯å¾„å®Œå…¨ç›¸ç­‰æˆ–åç¼€åŒ¹é…ï¼‰
- ç­–ç•¥ 2: çˆ¶ç›®å½•å¤±æ•ˆï¼ˆä¿®æ”¹ `src/main.py` æ—¶å¤±æ•ˆ `list_dir("src")` ç¼“å­˜ï¼‰
- ç­–ç•¥ 3: å­è·¯å¾„åŒ¹é…ï¼ˆ`glob_file_search` ç»“æœä¸­åŒ…å«è¢«ä¿®æ”¹æ–‡ä»¶æ—¶å¤±æ•ˆï¼‰

**`tool_dispatch.py` - å†™åå¤±æ•ˆé€»è¾‘**:
- ä» `tr.payload` æå– `path` å­—æ®µ
- è°ƒç”¨ `invalidate_path(path)` è€Œé `clear()`
- æ— æ³•ç¡®å®šè·¯å¾„æ—¶å›é€€åˆ° `clear()` ä¿åº•

### 5.3 é¢„æœŸæ”¶ç›Š
- å¤šæ–‡ä»¶ç¼–è¾‘åœºæ™¯ä¸‹ç¼“å­˜å‘½ä¸­ç‡æå‡ 60%+
- å‡å°‘ä¸å¿…è¦çš„é‡å¤ IO å’Œ Token æ¶ˆè€—

---

## 4. ä»£ç å˜æ›´æ¸…å•

| æ–‡ä»¶ | å˜æ›´ç±»å‹ | è¯´æ˜ |
| :--- | :--- | :--- |
| `src/clude_code/tooling/tool_result_cache.py` | å¢å¼º | `invalidate_path` æ”¯æŒçˆ¶ç›®å½• |
| `src/clude_code/orchestrator/agent_loop/tool_dispatch.py` | ä¿®æ”¹ | `clear()` â†’ `invalidate_path()` |


