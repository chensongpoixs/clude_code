# P2: ä¸Šä¸‹æ–‡æº¢å‡ºæ¥æºåˆ†æ

> **çŠ¶æ€**: ğŸ”„ è¿›è¡Œä¸­  
> **å¼€å§‹æ—¶é—´**: 2026-01-23

---

## 1. æ—¥å¿—åˆ†æç»“æœ

### 1.1 å‘ç°çš„å…³é”®é—®é¢˜

ä» `.clude/logs/app.log` åˆ†æï¼Œå‘ç°ä»¥ä¸‹é—®é¢˜ï¼š

| é—®é¢˜ | è§‚å¯Ÿ | å½±å“ |
| :--- | :--- | :--- |
| **max_tokens è®¾ç½®è¿‡å¤§** | `max_tokens=409600`ï¼ˆçº¦ 400kï¼‰ | utilization è®¡ç®—å¤±çœŸï¼ˆæ˜¾ç¤º 51.3% ä½†å®é™…å¯èƒ½è¿œè¶… 100%ï¼‰ |
| **æ¶ˆæ¯æ•°æŒç»­å¢é•¿** | 63 â†’ 64 â†’ 65 â†’ 66 â†’ 67 â†’ 68 æ¡æ¶ˆæ¯ | è£å‰ªæœºåˆ¶æœªç”Ÿæ•ˆ |
| **é‡å¤é”™è¯¯æç¤º** | "ä½ çš„è¾“å‡ºæ—¢ä¸æ˜¯å·¥å…·è°ƒç”¨ JSON" è¢«é‡å¤è¿½åŠ  | æ¯è½®å¤±è´¥éƒ½è¿½åŠ æ–°æ¶ˆæ¯ï¼Œå¯¼è‡´é›ªå´© |
| **LLM è¿”å›å¤šä¸ª JSON** | `{"tool": "display"...}\n{"tool": "list_dir"...}` | è§£æå¤±è´¥ï¼Œè§¦å‘é‡è¯•å¾ªç¯ |

### 1.2 811% æº¢å‡ºçš„å¯èƒ½åŸå› 

æ ¹æ®ç”¨æˆ·æä¾›çš„æ—¥å¿—ç‰‡æ®µ `265759 tokens (811.0%)`ï¼š

```
å¦‚æœ max_tokens = 32768ï¼ˆæ ‡å‡†é…ç½®ï¼‰
åˆ™ utilization = 265759 / 32768 = 811%
```

**æº¢å‡ºæ¥æº**ï¼š
1. ç³»ç»Ÿæç¤ºè¯ï¼ˆ~3000 charsï¼‰
2. ç´¯ç§¯çš„å¯¹è¯å†å²ï¼ˆ60+ æ¡æ¶ˆæ¯ï¼‰
3. å·¥å…·è¿”å›ç»“æœï¼ˆç‰¹åˆ«æ˜¯ grep/read_file çš„å¤§é‡è¾“å‡ºï¼‰
4. é‡å¤çš„é”™è¯¯æç¤ºæ¶ˆæ¯

---

## 2. æ ¹æœ¬åŸå› åˆ†æ

### 2.1 è£å‰ªæœºåˆ¶å¤±æ•ˆ

`_trim_history` çš„å½“å‰é€»è¾‘ï¼š
```python
# æœ€è¿‘ 5 æ¡ï¼šHIGH ä¼˜å…ˆçº§
# æœ€è¿‘ 15 æ¡ï¼šMEDIUM ä¼˜å…ˆçº§
# å…¶ä»–ï¼šLOW ä¼˜å…ˆçº§
```

**é—®é¢˜**ï¼š
- åªæŒ‰"ä½ç½®"åˆ†ä¼˜å…ˆçº§ï¼Œä¸è€ƒè™‘"å†…å®¹å¤§å°"
- å¤§çš„å·¥å…·è¿”å›ç»“æœè¢«ä¿ç•™ï¼ˆå› ä¸ºæ˜¯"æœ€è¿‘"çš„ï¼‰
- ç³»ç»Ÿæç¤ºè¯ä¸è¢«è£å‰ªï¼ˆæ­£ç¡®ï¼‰ï¼Œä½†æ²¡æœ‰è€ƒè™‘å…¶å¯¹ token é¢„ç®—çš„å½±å“

### 2.2 é”™è¯¯é‡è¯•å¯¼è‡´æ¶ˆæ¯é›ªå´©

å½“ LLM è¿”å›æ— æ•ˆæ ¼å¼æ—¶ï¼š
```
[è½®æ¬¡ N] LLM è¿”å›æ— æ•ˆ JSON
    â†“
[ç³»ç»Ÿ] è¿½åŠ é”™è¯¯æç¤ºæ¶ˆæ¯
    â†“
[è½®æ¬¡ N+1] LLM ä»ç„¶è¿”å›æ— æ•ˆ JSON
    â†“
[ç³»ç»Ÿ] å†è¿½åŠ é”™è¯¯æç¤ºæ¶ˆæ¯
    â†“
å¾ªç¯ 20-30 æ¬¡ï¼Œæ¶ˆæ¯æ•°ä» 10 å¢é•¿åˆ° 60+
```

### 2.3 å·¥å…·è¿”å›ç»“æœè¿‡å¤§

`grep` å’Œ `read_file` è¿”å›çš„ç»“æœå¯èƒ½éå¸¸å¤§ï¼š
- `grep` æ‰¾åˆ° 200 ä¸ªåŒ¹é…ï¼Œæ¯ä¸ªåŒ…å«ä¸Šä¸‹æ–‡
- `read_file` è¯»å–æ•´ä¸ªæ–‡ä»¶ï¼ˆå¯èƒ½å‡ åƒè¡Œï¼‰

---

## 3. è§£å†³æ–¹æ¡ˆ

### 3.1 å·²å®æ–½çš„ P0 ä¿®å¤

âœ… **ç´§æ€¥æˆªæ–­**ï¼ˆ`llm_io.py`ï¼‰ï¼šå½“ utilization > 95% æ—¶ï¼Œå¼ºåˆ¶è£å‰ªåˆ° system + æœ€è¿‘ 3 æ¡æ¶ˆæ¯

### 3.2 éœ€è¦å®æ–½çš„ P2 ä¿®å¤

#### ä¿®å¤ 1: é”™è¯¯é‡è¯•æ¶ˆæ¯å»é‡

**ä½ç½®**: `execution.py` / `react.py`

**ç­–ç•¥**: ä¸æ˜¯æ¯æ¬¡å¤±è´¥éƒ½è¿½åŠ æ–°çš„é”™è¯¯æç¤ºï¼Œè€Œæ˜¯æ›¿æ¢æœ€åä¸€æ¡é”™è¯¯æç¤º

```python
# æ—§é€»è¾‘
loop._append_message(ChatMessage(role="user", content="ä½ çš„è¾“å‡ºæ— æ•ˆ..."))

# æ–°é€»è¾‘
if loop.messages[-1].role == "user" and "ä½ çš„è¾“å‡ºæ— æ•ˆ" in loop.messages[-1].content:
    loop.messages[-1] = ChatMessage(role="user", content="ä½ çš„è¾“å‡ºæ— æ•ˆ...")  # æ›¿æ¢
else:
    loop._append_message(ChatMessage(role="user", content="ä½ çš„è¾“å‡ºæ— æ•ˆ..."))  # è¿½åŠ 
```

#### ä¿®å¤ 2: å·¥å…·ç»“æœå‹ç¼©

**ä½ç½®**: `feedback.py`

**ç­–ç•¥**: å¯¹å¤§çš„å·¥å…·è¿”å›ç»“æœè¿›è¡Œæ›´æ¿€è¿›çš„æˆªæ–­

```python
# grep: æœ€å¤š 10 æ¡åŒ¹é…ï¼Œæ¯æ¡é¢„è§ˆ 100 chars
# read_file: æœ€å¤š 2000 charsï¼Œä½¿ç”¨å¤´å°¾é‡‡æ ·
```

#### ä¿®å¤ 3: åŸºäº Token çš„æ¶ˆæ¯è£å‰ª

**ä½ç½®**: `_trim_history`

**ç­–ç•¥**: åœ¨è£å‰ªæ—¶è€ƒè™‘æ¯æ¡æ¶ˆæ¯çš„ token å¤§å°ï¼Œä¼˜å…ˆåˆ é™¤å¤§æ¶ˆæ¯

---

## 4. å®ç°æ­¥éª¤

- [x] 4.1 å®ç°é”™è¯¯é‡è¯•æ¶ˆæ¯å»é‡ âœ…
- [x] 4.2 éªŒè¯å¹¶æ±‡æŠ¥ âœ…

---

## 5. ä»£ç å˜æ›´æ¸…å•

| æ–‡ä»¶ | å˜æ›´ç±»å‹ | è¯´æ˜ | çŠ¶æ€ |
| :--- | :--- | :--- | :--- |
| `src/clude_code/orchestrator/agent_loop/execution.py` | ä¿®æ”¹ | é”™è¯¯æ¶ˆæ¯å»é‡ | âœ… å·²å®Œæˆ |
| `src/clude_code/orchestrator/agent_loop/react.py` | æ— éœ€ä¿®æ”¹ | ReAct æ¨¡å¼ä¸‹æ— æ•ˆè¾“å‡ºè§†ä¸ºæœ€ç»ˆå›å¤ | - |

---

## 6. éªŒè¯ç»“æœ

### 6.1 ç¼–è¯‘æ£€æŸ¥
```
python -m compileall -q src\clude_code\orchestrator\agent_loop\execution.py
# Exit code: 0 âœ…
```

### 6.2 æ ¸å¿ƒå˜æ›´æ‘˜è¦

**`execution.py` ä¿®æ”¹**ï¼š
```python
# æ—§é€»è¾‘ï¼šæ¯æ¬¡å¤±è´¥éƒ½è¿½åŠ æ–°çš„é”™è¯¯æç¤º
loop.messages.append(ChatMessage(role="user", content=error_prompt))

# æ–°é€»è¾‘ï¼šæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨é”™è¯¯æç¤ºï¼Œå­˜åœ¨åˆ™è·³è¿‡
last_user_msg = next((m for m in reversed(loop.messages) if m.role == "user"), None)
if last_user_msg and "ä½ çš„è¾“å‡ºæ—¢ä¸æ˜¯å·¥å…·è°ƒç”¨" in last_user_msg.content:
    loop.logger.debug("[dim]è·³è¿‡é‡å¤é”™è¯¯æç¤ºï¼ˆå·²å­˜åœ¨ï¼‰[/dim]")
else:
    loop.messages.append(...)
```

### 6.3 é¢„æœŸæ”¶ç›Š

| åœºæ™¯ | æ—§è¡Œä¸º | æ–°è¡Œä¸º |
| :--- | :--- | :--- |
| LLM è¿ç»­ 10 æ¬¡è¿”å›æ— æ•ˆ JSON | è¿½åŠ  10 æ¡é”™è¯¯æç¤º | åªä¿ç•™ 1 æ¡é”™è¯¯æç¤º |
| æ¶ˆæ¯æ•°å¢é•¿ | 10 â†’ 30 æ¡ | 10 â†’ 11 æ¡ |
| Token ä½¿ç”¨ | æ€¥å‰§å¢é•¿ | ä¿æŒç¨³å®š |


