# 00｜总览：业界 “Claude Code / Code Agent CLI” 功能与核心模块

## 1. 目标与产品形态

“Claude Code/业界 Code Agent CLI”通常指：一个在本地仓库内运行的**编程助理代理（agent）**，通过与用户对话、理解代码库、调用工具（读写文件、搜索、执行命令、跑测试、提交 Git 等）来完成工程任务。

### 1.1 典型用户价值
- **从需求到可合并代码**：自动分析、修改、验证、生成 PR/变更说明。
- **减少上下文切换**：在一个对话里完成搜索、编辑、运行、修复。
- **可审计与可控**：所有工具调用、文件修改、命令执行都有记录，可回放。

### 1.2 非目标（建议明确）
- 不试图“完全自动化”所有任务；复杂变更必须有**显式确认**与可回滚机制。
- 不在默认配置下访问互联网或外部私网资源（企业版可配置）。
- 不绕过本地权限控制，不“偷读”密钥、浏览器数据、系统敏感目录等。

## 2. 功能矩阵（业界共性）

### 2.1 仓库理解
- 文件树浏览、按 glob 查找文件
- 精确搜索（grep/rg）
- 语义检索（embedding + 向量库/本地索引）
- 代码引用定位（符号、定义/引用，可对接 LSP）

### 2.2 任务执行
- 计划分解（todo/steps）
- 工具调用（读写文件、补丁、运行命令、生成 diff）
- 自检闭环（lint/test/build）
- 变更总结、PR 描述/变更说明

### 2.3 交互体验
- 流式输出、可折叠的工具调用日志
- 危险操作确认（写文件、删除文件、执行命令、推送远端）
- 失败恢复：重试、降级、回滚、最小化修复

### 2.4 安全与合规
- 工具权限分级（read-only / write / exec / network）
- 沙箱与工作区边界（只能访问 workspace 或白名单路径）
- 敏感信息保护（密钥/令牌/隐私）
- 可审计（操作日志、回放、签名）

## 3. 核心系统分层（建议参考架构）

### 3.1 层次与职责
- **交互层（UI/CLI）**：输入输出、渲染、确认、会话管理
- **代理层（Agent Orchestrator）**：状态机、计划/执行、重试与回滚
- **上下文层（Context Builder）**：收集用户意图 + 仓库信息，生成模型输入
- **工具层（Tooling）**：文件/搜索/命令/测试/Git 等能力，以统一协议暴露
- **索引层（Indexing/Retrieval）**：文件树、grep、语义向量、符号索引
- **持久层（Storage）**：会话记录、记忆、索引缓存、审计日志
- **安全层（Policy/Sandbox）**：权限、路径、网络、敏感信息策略
- **可观测层（Observability）**：指标、日志、Tracing、回放

## 4. 关键设计原则（保证可落地）

### 4.1 可控性优先
- 默认 **“先展示计划再执行”**
- 任何写操作与执行命令都必须经由工具层统一入口，受策略约束

### 4.2 可审计与可回放
- 每次工具调用都有：参数、返回、耗时、错误、影响范围（文件列表/命令）
- 每次文件写入都记录 diff/patch，支持撤销

### 4.3 可扩展（插件化工具）
- 工具定义有版本号、schema、权限声明
- 新增工具不破坏旧对话（向后兼容）

## 5. 约束与 SLO（建议写进需求）

### 5.1 性能与体验
- 常用搜索（grep）应在秒级返回（取决于仓库大小）
- 语义检索可异步构建索引，首轮退化为 grep + 文件树

### 5.2 稳定性
- 工具调用失败要可恢复：重试（指数退避）、降级、提示用户修复

### 5.3 安全边界
- 默认只允许访问 workspace
- 默认禁用网络；企业场景通过 allowlist 开启

## 6. 交付物建议（最小可用版本 MVP）

### 6.1 MVP（2~4 周可交付）
- CLI + 会话
- 文件树/读写文件
- grep 搜索
- 运行命令（受限）
- 计划分解 + 执行闭环
- 基础日志/审计

### 6.2 v1（可对标业界主流）
- 语义检索索引
- LSP/符号跳转（可选）
- git diff/commit + PR 文案
- 更强策略引擎与敏感信息防护


