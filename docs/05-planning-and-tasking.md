# 05｜计划分解与任务执行 (Planning & Tasking)

本规范定义了 Agent 如何将模糊的需求转化为可执行的步骤。通过“显式计划”机制，我们增强了 Agent 在复杂任务（如跨文件重构）中的逻辑严密性。

---

## 1. 计划生成器 (Planner)

在接收到复杂任务后，Agent 会优先进入 `PLANNING` 状态。

### 1.1 计划三要素
- **子任务拆解**: 将大目标分解为 3-7 个原子步骤。
- **依赖分析**: 明确步骤间的先后顺序（如“先定义接口，再实现类”）。
- **验证预案**: 为每个关键步骤预设一个校验动作（如“运行特定测试用例”）。

### 1.2 风险评估
- 自动识别“破坏性”动作（如修改核心支付逻辑、删除配置文件）。
- 针对高风险计划，强制要求用户确认后方可进入执行。

---

## 2. 任务运行时 (Todo Runtime)

Agent 会维护一个动态的 Todo 列表，并根据执行反馈实时更新。

| 状态 | 说明 |
| :--- | :--- |
| **Pending** | 计划中，尚未开始 |
| **In Progress** | 当前正在调用的工具所归属的任务 |
| **Completed** | 工具返回成功，且验证通过 |
| **Failed** | 工具报错或验证失败，需要重规划 |
| **Skipped** | 由于前置失败或逻辑变更，该步骤已不再需要 |

---

## 3. 动态重规划 (Re-planning)

Agent 必须具备在执行中“见招拆招”的能力：
- **发现新线索**: 当 `grep` 发现原计划未覆盖的关键文件时，自动插入“读取该文件”的步骤。
- **处理失败**: 当补丁应用冲突时，自动生成“读取最新内容并生成新补丁”的修复任务。
- **环境变更**: 当检测到缺少依赖（如 `npm install` 失败）时，向用户请求授权安装。

---

## 4. 结论 (Conclusion)

“先计划再执行”是区分 Code Agent 与普通 Chatbot 的重要标志。通过显式的计划分解，我们不仅提升了复杂任务的成功率，更让 Agent 的执行轨迹变得清晰、可预测且具备人类可理解的逻辑感。
