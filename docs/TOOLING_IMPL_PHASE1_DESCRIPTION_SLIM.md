# Phase 1: 工具描述精简 - 实现思考过程

> **开始时间**: 2026-01-23  
> **目标**: 精简所有工具的 summary/description，预期节省 600 tokens/请求

---

## 1. 问题分析

### 1.1 当前状态

通过分析 `tool_dispatch.py`，发现以下问题：

1. **summary 冗长**: 平均 20-50 字符，应控制在 15 字符以内
2. **description 详细**: 平均 100-200 字符，应控制在 50 字符以内
3. **args_schema.description**: 每个参数描述 20-50 字符，应控制在 15 字符以内
4. **重复信息**: summary 和 description 内容重叠

### 1.2 精简原则

| 字段 | 当前平均 | 目标 | 原则 |
|------|---------|------|------|
| summary | 30 chars | ≤15 chars | 动词+名词 |
| description | 150 chars | ≤50 chars | 仅关键提示 |
| 参数 description | 30 chars | ≤15 chars | 类型+用途 |

### 1.3 精简策略

1. **Summary**: 采用 "动词+宾语" 格式，如 "列出目录"、"搜索代码"
2. **Description**: 仅保留关键提示和限制，删除教程式说明
3. **参数描述**: 删除或极简化（类型已在 schema 中定义）
4. **Example**: 保留，这是 LLM 理解的关键

---

## 2. 实现计划

### 2.1 修改文件

- `src/clude_code/orchestrator/agent_loop/tool_dispatch.py`

### 2.2 工具清单与精简方案

| 工具 | 当前 summary | 精简后 summary | 当前 desc 长度 | 精简后 |
|------|-------------|---------------|---------------|--------|
| list_dir | "列出目录内容（只读）。" | "列出目录" | 120 | 30 |
| read_file | "读取文件内容（只读，支持 offset/limit 分段）。" | "读取文件" | 150 | 30 |
| glob_file_search | "按文件名模式查找文件（只读，支持 ** 递归）。" | "按名搜索文件" | 140 | 30 |
| grep | "全能跨语言代码搜索器。" | "正则搜索" | 180 | 40 |
| apply_patch | "补丁式编辑（写文件，支持 fuzzy）。" | "补丁编辑" | 200 | 40 |
| undo_patch | "回滚补丁（写文件，基于 undo_id）。" | "回滚补丁" | 130 | 30 |
| write_file | "写入文件（写文件）。" | "写入文件" | 180 | 30 |
| run_cmd | "执行命令（可能有副作用，受策略约束）。" | "执行命令" | 200 | 30 |
| search_semantic | "语义向量检索代码（RAG）。" | "语义搜索" | 100 | 20 |
| display | "向用户显示进度/结果消息。" | "显示消息" | 80 | 20 |
| webfetch | "获取网页内容并转换为 Markdown。" | "获取网页" | 120 | 30 |
| websearch | "网页搜索（DuckDuckGo）。" | "网页搜索" | 80 | 20 |
| codesearch | "代码搜索（GitHub/Sourcegraph）。" | "代码搜索" | 100 | 20 |
| todowrite | "创建/更新任务项。" | "创建任务" | 60 | 15 |
| todoread | "读取任务列表。" | "读取任务" | 50 | 15 |
| question | "向用户提问并等待回答。" | "提问用户" | 70 | 20 |
| load_skill | "加载预定义技能模板。" | "加载技能" | 80 | 20 |
| run_task | "启动子代理任务。" | "运行子任务" | 90 | 20 |
| get_task_status | "获取子任务状态。" | "任务状态" | 60 | 15 |
| get_weather | "获取实时天气信息。" | "获取天气" | 50 | 15 |
| get_weather_forecast | "获取天气预报。" | "天气预报" | 50 | 15 |

### 2.3 参数描述精简规则

1. **必需参数**: 保留简短描述（≤10 字符）
2. **可选参数**: 删除 description，仅保留 type 和 default
3. **enum 参数**: 保留 enum 列表，删除描述

---

## 3. 风险评估

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| LLM 不理解简化描述 | 低 | 中 | 保留 example_args |
| 参数使用错误增加 | 低 | 低 | 保留必需参数描述 |
| 回归测试失败 | 中 | 低 | 逐步精简，先测后改 |

---

## 4. 验收标准

- [ ] 所有工具 summary ≤ 15 字符
- [ ] 所有工具 description ≤ 50 字符
- [ ] 编译通过
- [ ] 导入测试通过
- [ ] 工具调用功能正常

---

## 5. 实现进度

| 步骤 | 状态 |
|------|------|
| 思考过程文档 | ✅ 已完成 |
| 实现代码 | ✅ 已完成 |
| 代码检查 | ✅ 已通过 |
| 汇报 | ✅ 已完成 |

---

## 6. 完成汇报

### 6.1 修改的工具

共精简 **21 个工具**的描述：

| 工具 | 原 summary | 新 summary | 节省字符 |
|------|-----------|-----------|---------|
| list_dir | 列出目录内容（只读）。 | 列出目录 | ~12 |
| read_file | 读取文件内容（只读，支持 offset/limit 分段）。 | 读取文件 | ~25 |
| glob_file_search | 按文件名模式查找文件（只读，支持 ** 递归）。 | 按名搜索文件 | ~22 |
| grep | 全能跨语言代码搜索器。 | 正则搜索 | ~10 |
| apply_patch | 补丁式编辑（写文件，支持 fuzzy）。 | 补丁编辑 | ~15 |
| undo_patch | 回滚补丁（写文件，基于 undo_id）。 | 回滚补丁 | ~15 |
| write_file | 写入文件（写文件）。 | 写入文件 | ~6 |
| run_cmd | 执行命令（可能有副作用，受策略约束）。 | 执行命令 | ~18 |
| search_semantic | 语义检索（向量 RAG，只读）。 | 语义搜索 | ~12 |
| display | 向用户输出信息（进度、分析结果、说明等，只读）。 | 显示消息 | ~25 |
| ... | ... | ... | ... |

### 6.2 Token 节省估算

| 项目 | 估算值 |
|------|--------|
| summary 精简 | ~15 tokens/工具 × 21 = **315 tokens** |
| description 精简 | ~30 tokens/工具 × 21 = **630 tokens** |
| 参数描述删除 | ~10 tokens/工具 × 21 = **210 tokens** |
| **总计** | **~1155 tokens/请求** |

### 6.3 验证结果

- ✅ 编译通过
- ✅ Lint 无错误
- ✅ 工具导入测试通过（23 个工具正常加载）
- ✅ summary 均已精简到 ≤10 字符

### 6.4 风险评估

- **LLM 理解度**: 保留了 example_args，LLM 仍可正确推断参数用法
- **向后兼容**: 工具名称和参数名未变，不影响现有调用

