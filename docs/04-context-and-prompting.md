# 04｜上下文构建与提示词体系 (Context & Prompting)

本规范定义了 Agent 的“感知层”。目标是在 Token 预算有限的情况下，为模型提供高相关、低噪音的上下文，从而提升任务一次成功率。

---

## 1. 上下文收集器 (Context Collector)

Agent 在每一轮对话前，会动态装配以下信息源：

| 信息源 | 核心内容 | 作用 |
| :--- | :--- | :--- |
| **基础环境** | 操作系统、Python 版本、当前工作区路径 | 确保命令执行的兼容性 |
| **仓库地图** | Repo Map (ctags 符号摘要) | 提供全局架构视野，减少盲目搜索 |
| **检索命中** | Grep 关键词匹配 + 语义检索片段 | 提供具体业务逻辑相关的代码细节 |
| **任务状态** | 当前 Todo List 进度、历史工具调用结果 | 维持逻辑连贯性，避免重复尝试 |
| **用户反馈** | 错误堆栈、截图描述、手工录入的代码片段 | 补充 Agent 无法通过工具获取的动态信息 |

---

## 2. 提示词分层体系 (Prompt Hierarchy)

我们采用三层提示词结构，确保指令的刚性约束与任务的灵活性。

### 2.1 System Prompt (固定指令)
- **身份设定**: 定义 Agent 是一个纯 CLI 编程助理。
- **协议约束**: 强制要求通过 JSON 调用工具，严禁非必要的自由文本回复。
- **安全准则**: 禁止删除非空目录、禁止越权访问敏感文件（如 `.env`）。

### 2.2 Developer Prompt (策略注入)
- **代码规范**: 注入项目特定的命名约定、测试框架要求（如“优先使用 pytest”）。
- **编辑偏好**: 强调使用 `apply_patch` 进行局部修改，而非整文件重写。

### 2.3 User Message (动态任务)
- **任务描述**: 用户当前的自然语言指令。
- **上下文补充**: 经过 Rerank 过滤后的代码片段块。

---

## 3. 上下文压缩与裁剪 (Pruning & Compression)

为了防止上下文窗口溢出，系统会执行以下策略：
1. **语义窗口采样**: 对于 `read_file` 返回的大型文件，仅保留与当前任务关键词匹配的“窗口片段”。
2. **工具回喂摘要**: 将冗长的工具输出（如数千行的构建日志）总结为结构化摘要。
3. **历史裁剪**: 仅保留最近 3-5 次的完整工具交互，更早的历史转化为精简的 `Action Summary`。

---

## 4. 结论 (Conclusion)

上下文构建不是简单的“全量填充”，而是一场关于“信息密度”的权衡。一个优秀的 Context Builder 能够让 7B/14B 等中小型本地模型发挥出不亚于 32B/70B 模型的工程实战能力。
