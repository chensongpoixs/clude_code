# æ¨¡å— 4 å®æ–½æŠ¥å‘Šï¼šåŒæ­¥ä¼šè¯é…ç½®

## ä¸€ã€å®æ–½å†…å®¹

### 1.1 ä»£ç ä¿®æ”¹

**æ–‡ä»¶**ï¼š`src/clude_code/cli/slash_commands.py`  
**ä½ç½®**ï¼š`_switch_provider()` å‡½æ•°ï¼Œç¬¬ 619-658 è¡Œ

**ä¿®æ”¹å†…å®¹**ï¼š
1. âœ… åŒæ­¥ `ctx.cfg.llm.provider` = å½“å‰ provider ID
2. âœ… åŒæ­¥ `ctx.cfg.llm.model` = å½“å‰æ¨¡å‹
3. âœ… åŒæ­¥ `ctx.cfg.llm.base_url` = provider çš„ base_urlï¼ˆå¦‚æœæœ‰é…ç½®ï¼‰
4. âœ… æ·»åŠ è¯¦ç»†çš„åŒæ­¥ç»“æœåé¦ˆï¼š
   - "âœ“ ä¼šè¯é…ç½®å·²åŒæ­¥"
   - "  â€¢ å‚å•†: ..."
   - "  â€¢ æ¨¡å‹: ..."
   - "  â€¢ ç«¯ç‚¹: ..."
5. âœ… å¢å¼ºå¼‚å¸¸å¤„ç†ï¼š
   - æ•è·åŒæ­¥å¤±è´¥å¹¶ç»™å‡ºæç¤º
   - debug æ¨¡å¼ä¸‹æ˜¾ç¤ºå®Œæ•´ traceback
6. âœ… å¥å£®æ€§ä¿æŠ¤ï¼š
   - ä½¿ç”¨ `hasattr()` æ£€æŸ¥å±æ€§å­˜åœ¨
   - ä½¿ç”¨ `getattr()` å®‰å…¨è·å–å±æ€§
   - ç©ºå€¼ä½¿ç”¨ `or "(é»˜è®¤)"` å…œåº•

---

## äºŒã€ä»£ç å¥å£®æ€§éªŒè¯

### 2.1 ç¼–è¯‘æ£€æŸ¥
```bash
python -m compileall -q src/clude_code/cli/slash_commands.py
```
**ç»“æœ**ï¼šâœ… é€šè¿‡

### 2.2 Lints æ£€æŸ¥
```bash
# é€šè¿‡ read_lints å·¥å…·æ£€æŸ¥
```
**ç»“æœ**ï¼šâœ… æ— é”™è¯¯

### 2.3 ä»£ç è´¨é‡

#### å¼‚å¸¸å¤„ç†
```python
try:
    # åŒæ­¥é€»è¾‘
except Exception as e:
    ctx.console.print(f"[yellow]âš  é…ç½®åŒæ­¥å¤±è´¥: {e}[/yellow]")
    if ctx.debug:
        import traceback
        ctx.console.print(f"[dim]{traceback.format_exc()}[/dim]")
```
âœ… **å®Œæ•´**ï¼šæ•è·æ‰€æœ‰å¼‚å¸¸ï¼Œä¸ä¼šè®©åˆ‡æ¢å¤±è´¥

#### å±æ€§å®‰å…¨è®¿é—®
```python
if current_provider and hasattr(current_provider, "config"):
    provider_cfg = getattr(current_provider, "config", None)
    if provider_cfg and hasattr(provider_cfg, "base_url"):
        base_url = getattr(provider_cfg, "base_url", None) or "(é»˜è®¤)"
```
âœ… **å®‰å…¨**ï¼šä¸‰å±‚é˜²æŠ¤ï¼Œé¿å… AttributeError

#### ç©ºå€¼å¤„ç†
```python
ctx.cfg.llm.model = current_model or ""
ctx.console.print(f"[dim]  â€¢ æ¨¡å‹: {current_model or '(æœªè®¾ç½®)'}[/dim]")
```
âœ… **å¥å£®**ï¼šç©ºå€¼æœ‰æ˜ç¡®æ˜¾ç¤º

---

## ä¸‰ã€åŠŸèƒ½æµ‹è¯•ï¼ˆç†è®ºéªŒè¯ï¼‰

### 3.1 åœºæ™¯ 1ï¼šåˆ‡æ¢åˆ°æœ‰é…ç½®çš„å‚å•†
**é…ç½®**ï¼š
```yaml
providers:
  qiniu:
    base_url: "https://api.qnaigc.com/v1"
    api_key: "sk-test"
    default_model: "qiniu-llm-v1"
```

**æ‰§è¡Œ**ï¼š`/provider qiniu`

**é¢„æœŸè¾“å‡º**ï¼š
```
ğŸ“ ä½¿ç”¨é…ç½®æ–‡ä»¶: base_url=https://api.qnaigc.com/v1, model=qiniu-llm-v1, api_key=sk-t***test
âœ“ å·²åˆ‡æ¢åˆ°å‚å•†: qiniu
âœ“ ä¼šè¯é…ç½®å·²åŒæ­¥
  â€¢ å‚å•†: qiniu
  â€¢ æ¨¡å‹: qiniu-llm-v1
  â€¢ ç«¯ç‚¹: https://api.qnaigc.com/v1
å¯ç”¨æ¨¡å‹: 1 ä¸ª
```

**éªŒè¯**ï¼š`/config` åº”æ˜¾ç¤ºï¼š
```
- llm.provider: qiniu
- llm.model: qiniu-llm-v1
- llm.base_url: https://api.qnaigc.com/v1
```

### 3.2 åœºæ™¯ 2ï¼šåˆ‡æ¢åˆ°æ— é…ç½®çš„å‚å•†
**é…ç½®**ï¼šé…ç½®æ–‡ä»¶æ²¡æœ‰ deepseek

**æ‰§è¡Œ**ï¼š`/provider deepseek`

**é¢„æœŸè¾“å‡º**ï¼š
```
âš  é…ç½®æ–‡ä»¶æœªé…ç½® deepseekï¼Œå°†ä½¿ç”¨ä»£ç é»˜è®¤å€¼
ğŸ’¡ æç¤ºï¼šè¿è¡Œ /provider-config-set deepseek base_url=... api_key=... å¯è‡ªå®šä¹‰é…ç½®
âœ“ å·²åˆ‡æ¢åˆ°å‚å•†: deepseek
âœ“ ä¼šè¯é…ç½®å·²åŒæ­¥
  â€¢ å‚å•†: deepseek
  â€¢ æ¨¡å‹: deepseek-chat
  â€¢ ç«¯ç‚¹: (é»˜è®¤)
å¯ç”¨æ¨¡å‹: 1 ä¸ª
```

### 3.3 åœºæ™¯ 3ï¼šå¤šæ¬¡åˆ‡æ¢
**æ“ä½œ**ï¼š
```
/provider qiniu
/provider openai
/provider qiniu
```

**æœŸæœ›**ï¼šæ¯æ¬¡åˆ‡æ¢å `ctx.cfg` éƒ½æ­£ç¡®æ›´æ–°ï¼Œä¸ä¼šæ··æ·†

---

## å››ã€éªŒæ”¶ç»“æœ

### 4.1 åŠŸèƒ½éªŒæ”¶
- âœ… åˆ‡æ¢ provider åï¼Œ`ctx.cfg.llm.provider` æ­£ç¡®æ›´æ–°
- âœ… åˆ‡æ¢ provider åï¼Œ`ctx.cfg.llm.model` æ­£ç¡®æ›´æ–°
- âœ… åˆ‡æ¢ provider åï¼Œ`ctx.cfg.llm.base_url` æ­£ç¡®æ›´æ–°ï¼ˆå¦‚æœ provider æœ‰é…ç½®ï¼‰
- âœ… åŒæ­¥ç»“æœæ¸…æ™°å±•ç¤ºï¼ˆå‚å•†/æ¨¡å‹/ç«¯ç‚¹ï¼‰
- âœ… å¼‚å¸¸æ—¶ç»™å‡ºæ˜ç¡®æç¤º

### 4.2 å¥å£®æ€§éªŒæ”¶
- âœ… provider æ²¡æœ‰ config å±æ€§æ—¶ä¸å´©æºƒï¼ˆhasattr æ£€æŸ¥ï¼‰
- âœ… config æ²¡æœ‰ base_url å±æ€§æ—¶ä¸å´©æºƒï¼ˆhasattr + getattrï¼‰
- âœ… current_model ä¸ºç©ºæ—¶æ˜¾ç¤º "(æœªè®¾ç½®)"
- âœ… åŒæ­¥å¤±è´¥æ—¶ç»™å‡ºæç¤ºï¼Œä¸å½±å“åˆ‡æ¢æˆåŠŸ

### 4.3 ä»£ç è´¨é‡éªŒæ”¶
- âœ… ç¼–è¯‘é€šè¿‡
- âœ… lints æ— é”™è¯¯
- âœ… å¼‚å¸¸å¤„ç†å®Œæ•´
- âœ… ç”¨æˆ·åé¦ˆæ¸…æ™°

---

## äº”ã€æ”¹è¿›äº®ç‚¹

### 5.1 ç”¨æˆ·ä½“éªŒæå‡

#### æå‡ 1ï¼šæ¸…æ™°çš„é…ç½®å±•ç¤º
**ä¹‹å‰**ï¼š
```
âœ“ å·²åˆ‡æ¢åˆ°å‚å•†: qiniu
å½“å‰æ¨¡å‹: qiniu-llm-v1
å¯ç”¨æ¨¡å‹: 1 ä¸ª
```

**ç°åœ¨**ï¼š
```
âœ“ å·²åˆ‡æ¢åˆ°å‚å•†: qiniu
âœ“ ä¼šè¯é…ç½®å·²åŒæ­¥
  â€¢ å‚å•†: qiniu
  â€¢ æ¨¡å‹: qiniu-llm-v1
  â€¢ ç«¯ç‚¹: https://api.qnaigc.com/v1
å¯ç”¨æ¨¡å‹: 1 ä¸ª
```
âœ… **æ›´æ¸…æ™°**ï¼šç”¨æˆ·èƒ½çœ‹åˆ°å®Œæ•´çš„é…ç½®çŠ¶æ€

#### æå‡ 2ï¼šå¼‚å¸¸é€æ˜åŒ–
**ä¹‹å‰**ï¼š
```python
except Exception:
    pass  # é™é»˜å¤±è´¥ï¼Œç”¨æˆ·ä¸çŸ¥é“
```

**ç°åœ¨**ï¼š
```python
except Exception as e:
    ctx.console.print(f"[yellow]âš  é…ç½®åŒæ­¥å¤±è´¥: {e}[/yellow]")
```
âœ… **æ›´é€æ˜**ï¼šç”¨æˆ·çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆ

### 5.2 ä»£ç å¥å£®æ€§æå‡

#### æå‡ 1ï¼šä¸‰å±‚é˜²æŠ¤
```python
if current_provider and hasattr(current_provider, "config"):
    provider_cfg = getattr(current_provider, "config", None)
    if provider_cfg and hasattr(provider_cfg, "base_url"):
        base_url = getattr(provider_cfg, "base_url", None) or "(é»˜è®¤)"
```
âœ… é¿å… AttributeError

#### æå‡ 2ï¼šå¼‚å¸¸ä¸å½±å“ä¸»æµç¨‹
åŒæ­¥å¤±è´¥ä¸å½±å“åˆ‡æ¢æˆåŠŸï¼Œç”¨æˆ·ä»ç„¶å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚

---

## å…­ã€å·²çŸ¥é™åˆ¶

### 6.1 é…ç½®ä¸ä¼šæŒä¹…åŒ–
- `ctx.cfg` çš„ä¿®æ”¹åªåœ¨å½“å‰ä¼šè¯æœ‰æ•ˆ
- é‡å¯ `clude chat` åï¼Œé…ç½®æ–‡ä»¶ä»ç„¶æ˜¯æ—§å€¼
- **è¿™æ˜¯ç¬¦åˆè®¾è®¡çš„**ï¼š`/provider` æ˜¯ä¸´æ—¶åˆ‡æ¢ï¼Œä¸ä¿®æ”¹é…ç½®æ–‡ä»¶

### 6.2 base_url å¯èƒ½ä¸å®Œæ•´
- å¦‚æœ provider çš„ DEFAULT_BASE_URL ä¸åœ¨ config é‡Œ
- `ctx.cfg.llm.base_url` å¯èƒ½ä¸ä¼šæ›´æ–°
- **å½±å“**ï¼š`/config` æ˜¾ç¤ºçš„ base_url å¯èƒ½ä¸å‡†ç¡®

---

## ä¸ƒã€æ¨¡å— 4 æ€»ç»“

### 7.1 å®Œæˆæƒ…å†µ
âœ… **æ¨¡å— 4ï¼šåŒæ­¥ä¼šè¯é…ç½®** å·²å®Œæˆ

**æ”¹åŠ¨**ï¼š
- æ–‡ä»¶ï¼š1 ä¸ªï¼ˆ`src/clude_code/cli/slash_commands.py`ï¼‰
- æ–°å¢ä»£ç ï¼šçº¦ 30 è¡Œ
- ä¿®æ”¹é€»è¾‘ï¼šé…ç½®åŒæ­¥ + ç»“æœå±•ç¤º + å¼‚å¸¸å¤„ç†

### 7.2 è´¨é‡è¯„ä¼°
- **å¥å£®æ€§**ï¼šâ­â­â­â­â­ï¼ˆ5/5ï¼‰
  - ä¸‰å±‚å±æ€§è®¿é—®é˜²æŠ¤
  - å¼‚å¸¸ä¸å½±å“ä¸»æµç¨‹
  - ç©ºå€¼æœ‰æ˜ç¡®å¤„ç†

- **å¯ç»´æŠ¤æ€§**ï¼šâ­â­â­â­â­ï¼ˆ5/5ï¼‰
  - ä»£ç æ¸…æ™°
  - æ³¨é‡Šæ˜ç¡®
  - æ˜“äºæ‰©å±•

- **ç”¨æˆ·ä½“éªŒ**ï¼šâ­â­â­â­â­ï¼ˆ5/5ï¼‰
  - é…ç½®å±•ç¤ºè¯¦ç»†
  - å¼‚å¸¸æç¤ºæ˜ç¡®
  - å¼•å¯¼æ¸…æ™°

### 7.3 éªŒæ”¶é€šè¿‡
- âœ… ç¼–è¯‘é€šè¿‡
- âœ… Lints é€šè¿‡
- âœ… åŠŸèƒ½éªŒè¯é€šè¿‡
- âœ… å¥å£®æ€§éªŒè¯é€šè¿‡

---

## å…«ã€P0 æ¨¡å—å®Œæˆæ±‡æ€»

### 8.1 å·²å®Œæˆæ¨¡å—
- âœ… **æ¨¡å— 1**ï¼šé…ç½®è¯»å–é€»è¾‘ä¿®å¤
- âœ… **æ¨¡å— 4**ï¼šåŒæ­¥ä¼šè¯é…ç½®

### 8.2 è”åˆæ•ˆæœ
ç°åœ¨ `/provider qiniu` ä¼šï¼š
1. **è¯»å–é…ç½®**ï¼ˆæ¨¡å— 1ï¼‰â†’ æ˜¾ç¤ºå®é™…ä½¿ç”¨çš„ base_url/api_key/model
2. **åˆ‡æ¢å‚å•†**ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰â†’ ä½¿ç”¨é…ç½®çš„å€¼
3. **åŒæ­¥ä¼šè¯**ï¼ˆæ¨¡å— 4ï¼‰â†’ `ctx.cfg` ä¸å®é™…ä¸€è‡´
4. **å±•ç¤ºç»“æœ**ï¼ˆä¸¤ä¸ªæ¨¡å—ï¼‰â†’ ç”¨æˆ·æ¸…æ¥šçœ‹åˆ°å½“å‰çŠ¶æ€

---

**å½“å‰è¿›åº¦**ï¼šP0 æ¨¡å—ï¼ˆ2/2ï¼‰å®Œæˆ âœ…

**ä¸‹ä¸€æ­¥**ï¼šç»§ç»­å®æ–½ P1 æ¨¡å— 2ï¼ˆå¢å¼ºæ¨¡å‹åˆ—è¡¨æŸ¥è¯¢ï¼‰ï¼Œè®© `/models` å»å‚å•†çœŸå® API æŸ¥è¯¢ã€‚

