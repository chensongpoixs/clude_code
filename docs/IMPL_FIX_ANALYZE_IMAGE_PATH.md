# ä¿®å¤ analyze_image ä½¿ç”¨é”™è¯¯è·¯å¾„

> **ç›®æ ‡**: è®© analyze_image ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„çœŸå®å›¾ç‰‡è·¯å¾„ï¼ˆæˆ– URLï¼‰
> **çŠ¶æ€**: ğŸ”„ è¿›è¡Œä¸­

---

## 1. é—®é¢˜åˆ†æ

### 1.1 ç°è±¡
æ‰§è¡Œé˜¶æ®µ LLM è°ƒç”¨å·¥å…·æ—¶ä¼ å…¥äº†ä¸å­˜åœ¨çš„è·¯å¾„ï¼š
```
{"tool": "analyze_image", "args": {"path": "design.png", ...}}
```
å¯¼è‡´å·¥å…·æ‰§è¡Œå¤±è´¥ï¼š
```
[ImageUtils] å›¾ç‰‡ä¸å­˜åœ¨: design.png
```

### 1.2 æ ¹å› 
1. ç”¨æˆ·è¾“å…¥å›¾ç‰‡è·¯å¾„å­˜åœ¨äº CLI è§£æé˜¶æ®µï¼Œä½†æœªå‘æ‰§è¡Œé˜¶æ®µé€ä¼ 
2. LLM ä¸çŸ¥é“çœŸå®è·¯å¾„ï¼Œåªèƒ½çŒœæµ‹æ–‡ä»¶å
3. analyze_image ä»…ä½¿ç”¨ LLM ä¼ å…¥ pathï¼Œæ— å›é€€æœºåˆ¶

---

## 2. è§£å†³æ€è·¯

### 2.1 è·¯å¾„é€ä¼ 
åœ¨ CLI è§£æ `@image:` æ—¶è®°å½•è·¯å¾„ï¼Œå¹¶ä¼ é€’ç»™ AgentLoopï¼š
- `chat_handler.py` è§£æå›¾ç‰‡ â†’ `image_paths`
- `agent_loop.run_turn` æ¥æ”¶ `image_paths` å¹¶å­˜å…¥ `_last_image_paths`

### 2.2 å›é€€æœºåˆ¶
åœ¨å·¥å…·å¤„ç†å±‚è¿›è¡Œå®¹é”™ï¼š
- å¦‚æœ `args["path"]` ä¸å­˜åœ¨æˆ–ä¸å­˜åœ¨äºç£ç›˜
- ä½¿ç”¨ `loop._last_image_paths` ä¸­æœ€è¿‘çš„ä¸€æ¡è·¯å¾„æ›¿æ¢

---

## 3. å®æ–½æ–¹æ¡ˆ

### 3.1 ä¿®æ”¹ CLI è¾“å…¥è§£æ
æ–‡ä»¶ï¼š`src/clude_code/cli/chat_handler.py`
- `_extract_images_from_input` è¿”å› `(clean_text, images, image_paths)`
- è¿è¡Œæ—¶å°† `image_paths` ä¼ å…¥ `run_turn`

### 3.2 ä¿®æ”¹ Slash Command
æ–‡ä»¶ï¼š`src/clude_code/cli/slash_commands.py`
- `/image` é¢„åŠ è½½æ—¶åŒæ—¶è®°å½•è·¯å¾„åˆ° `_pending_image_paths`

### 3.3 ä¿®æ”¹ AgentLoop
æ–‡ä»¶ï¼š`src/clude_code/orchestrator/agent_loop/agent_loop.py`
- `run_turn` æ–°å¢å‚æ•° `image_paths`
- ä¿å­˜åˆ° `self._last_image_paths`

### 3.4 ä¿®æ”¹ analyze_image å¤„ç†
æ–‡ä»¶ï¼š`src/clude_code/orchestrator/agent_loop/tool_dispatch.py`
- å¦‚æœä¼ å…¥ path æ— æ•ˆï¼Œè‡ªåŠ¨å›é€€åˆ° `loop._last_image_paths[0]`

---

## 4. é¢„æœŸæ•ˆæœ

### ä¿®å¤å‰
```
LLM: {"tool":"analyze_image","args":{"path":"design.png"}}
å·¥å…·æ‰§è¡Œ: âŒ å›¾ç‰‡ä¸å­˜åœ¨
```

### ä¿®å¤å
```
LLM: {"tool":"analyze_image","args":{"path":"design.png"}}
å›é€€: ä½¿ç”¨ä¸Šæ¬¡ç”¨æˆ·è¾“å…¥å›¾ç‰‡è·¯å¾„
å·¥å…·æ‰§è¡Œ: âœ… æˆåŠŸåŠ è½½
```

---

## 5. é£é™©è¯„ä¼°

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
| :--- | :--- | :--- |
| è·¯å¾„åˆ—è¡¨ä¸ºç©º | ä¸­ | ä¿ç•™åŸå§‹é”™è¯¯ |
| URL æ— æ³•è®¿é—® | ä¸­ | ä»ç”±å·¥å…·æŠ¥é”™ |
| å¤šå›¾åŒ¹é…é”™è¯¯ | ä½ | å…ˆä½¿ç”¨æœ€è¿‘ä¸€å¼  |

---

## 6. æµ‹è¯•ç”¨ä¾‹

1. ç”¨æˆ·è¾“å…¥ `@image:D:/.../a.png`ï¼ŒLLM è°ƒç”¨ `design.png` â†’ åº”å›é€€åˆ°çœŸå®è·¯å¾„
2. `/image` é¢„åŠ è½½åç›´æ¥æé—® â†’ åº”ä½¿ç”¨é¢„åŠ è½½è·¯å¾„
3. æ— å›¾ç‰‡è¾“å…¥ â†’ analyze_image ä»æŠ¥è·¯å¾„ä¸å­˜åœ¨ï¼ˆé¢„æœŸï¼‰


