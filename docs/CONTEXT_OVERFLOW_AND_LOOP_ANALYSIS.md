# Agent 运行期异常分析报告：上下文溢出与执行死循环

## 1. 核心问题定义

根据日志排查，系统在执行 `step_8`（C++ 符号提取）时进入了不可控状态：

### 1.1 上下文计算失控
- **数据**：Token 数达到 389,608，占用率 1189.0%。
- **结论**：当前 `AdvancedContextManager` 存在重大漏洞。它在“智能裁剪”时主要依据消息条数，而忽略了**单条消息的 Token 贡献度**。一旦某次工具返回（如 `grep`）包含了数万行代码，即便消息只有 1 条，也会撑爆上下文。

### 1.2 逻辑死循环（Stuck in Loop）
- **数据**：轮次达到 49 轮，且在 `display` 与 `grep` 之间机械重复。
- **结论**：
    - 模型因上下文溢出失去了对“已尝试正则”的记忆。
    - `AgentLoop` 缺乏“重复动作阻断”逻辑。
    - 模型生成的 C++ 正则（复杂的贪婪匹配）可能导致工具返回了过多无用信息，进一步恶化了上下文。

---

## 2. 改进算法设计

### 2.1 强制消息体截断（Token Budget Enforcement）
- **逻辑**：在 `AgentLoop._trim_history` 之前，先遍历所有消息。
- **规则**：
    - `system` 消息：严禁截断。
    - `user/assistant` 消息：若单条 token 数超过全局预算的 20%（例如 8000 token），强制保留头尾，中间用 `[... Content Truncated ...]` 替换。

### 2.2 循环检测与自省注入
- **逻辑**：在 `execute_plan_steps` 中增加 `ActionTracker`。
- **规则**：
    - 记录最近 5 次工具调用。
    - 若 `tool_name` 且 `args` 指纹相似度 > 80%，在下一次 `llm_chat` 前注入一段 `system` 级别强制提示：
      > "警告：你已连续多次执行相似的搜索但未取得进展。请审视正则是否正确，或考虑读取文件直接分析，不要盲目重试。"

---

## 3. 落地计划

1. **完善 `advanced_context.py`**：实现基于 token 数的单条消息强制截断逻辑。
2. **完善 `agent_loop.py`**：
    - 降低 `max_step_tool_calls` 的默认容忍度（当前 100 太高，建议 20）。
    - 增加调用指纹校验。
3. **完善 `feedback.py`**：为 `grep` 等工具增加更严格的“按字符数”物理截断，而不只是“按条数”。

