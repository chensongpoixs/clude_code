# 07｜运行时与命令执行 (Runtime & Terminal)

本规范定义了 Agent 如何在本地安全、受控地执行构建、测试与通用脚本。核心目标是平衡“执行灵活性”与“系统安全性”。

---

## 1. 命令运行规格 (Execution Spec)

### 1.1 Command Runner
- **职责**: 封装子进程管理，提供统一的执行接口。
- **关键属性**:
    - `timeout`: 强制执行上限（默认 300s），防止僵尸进程。
    - `cwd`: 默认限制在工作区根目录。
    - `env`: 隔离的环境变量（默认脱敏）。

### 1.2 输出管理 (Output Handling)
- **尾部采样 (Tail Sampling)**: 当输出超过 1MB 时，优先保留最后的 500KB（因为编译报错通常在末尾）。
- **去噪 (Denoising)**: 自动识别并过滤进度条 (`0%...100%`)、ANSI 转义字符与重复的警告噪音。
- **结构化回喂**: 识别并解析 `file:line:col: error` 格式，作为高权重的“错误锚点”回馈给模型。

---

## 2. 安全与准入策略 (Safety & Policy)

| 策略 | 动作 | 说明 |
| :--- | :--- | :--- |
| **网络隔离** | 拦截 `curl`, `wget`, `npm publish` | 防止代码或密钥外泄 |
| **破坏性限制** | 拦截 `rm -rf /`, `mkfs`, `dd` | 保护文件系统安全 |
| **敏感信息脱敏** | 过滤输出中的 `Key`, `Token`, `Password` | 防止模型记忆敏感凭证 |
| **用户确认** | 针对写操作或未授权命令挂起 | 终极控制权交还人类 |

---

## 3. 后台任务管理 (Background Jobs)

Agent 有权启动后台服务（如 `npm start`, `python dev_server.py`）：
- **生存监控**: 主进程退出时，自动清理（SIGTERM）所有由 Agent 派生的子进程。
- **日志订阅**: 提供 `read_logs` 工具，允许 Agent 在任务运行期间异步观察输出，判断服务是否就绪。

---

## 4. 结论 (Conclusion)

终端是 Agent 的“武馆”。一个安全的运行时环境既能让 Agent 自由地通过测试和构建来验证其想法，又能确保开发者的主机环境不受恶意或错误代码的侵害。
