# P1: å¼ºåŒ– replan.j2 æç¤ºè¯

> **çŠ¶æ€**: ğŸ”„ è¿›è¡Œä¸­  
> **å¼€å§‹æ—¶é—´**: 2026-01-23

---

## 1. é—®é¢˜åˆ†æ

### 1.1 å½“å‰ replan.j2 çš„ç¼ºé™·

```jinja2
#çº¦æŸï¼š

- steps æ€»æ•°ä¸è¶…è¿‡ {{max_plan_steps}}
- ç¦æ­¢åˆ é™¤/ä¿®æ”¹ status=done çš„æ­¥éª¤
- æ–°å¢æ­¥éª¤çš„ status ä¼šè¢«å¼ºåˆ¶è®¾ä¸º pending
```

**ç¼ºå¤±çš„å…³é”®çº¦æŸ**ï¼š
- æ²¡æœ‰æ˜ç¡®è¯´æ˜"åŒä¸€æ­¥éª¤ä¸èƒ½åŒæ—¶å‡ºç°åœ¨ remove/update/add ä¸­"
- æ²¡æœ‰ç»™å‡ºé”™è¯¯ç¤ºä¾‹å’Œæ­£ç¡®ç¤ºä¾‹
- LLM å®¹æ˜“è¯¯è§£"æ›¿æ¢æ­¥éª¤"çš„è¯­ä¹‰

### 1.2 LLM çš„å¸¸è§é”™è¯¯æ¨¡å¼

| é”™è¯¯æ¨¡å¼ | LLM æ„å›¾ | æ­£ç¡®åšæ³• |
| :--- | :--- | :--- |
| `remove: [step_2], update: [{id: step_2, ...}]` | "æ›¿æ¢ step_2" | åªç”¨ `update` |
| `update: [{id: step_2, ...}], add: [{id: step_2, ...}]` | "æ›´æ–°å¹¶æ ‡è®°" | åªç”¨ `update` |
| `update: [{language: "cpp", ...}]` | "æŒ‡å®šè¯­è¨€" | ä¸å…è®¸ extra å­—æ®µ |

---

## 2. è®¾è®¡æ–¹æ¡ˆ

### 2.1 æ”¹è¿›ç›®æ ‡
1. **æ˜¾å¼å£°æ˜å†²çªçº¦æŸ**ï¼šç”¨é†’ç›®æ ¼å¼å¼ºè°ƒ
2. **æä¾›æ­£è¯¯ç¤ºä¾‹**ï¼šè®© LLM ç›´è§‚ç†è§£
3. **ç®€åŒ–å­—æ®µè¯´æ˜**ï¼šåªåˆ—å…è®¸çš„å­—æ®µï¼Œé¿å…"åˆ›é€ "æ–°å­—æ®µ

### 2.2 æ–°å¢å†…å®¹

```jinja2
## âš ï¸ å…³é”®çº¦æŸï¼ˆå¿…é¡»éµå®ˆï¼‰

**å”¯ä¸€æ€§è§„åˆ™**ï¼šåŒä¸€ä¸ª step_id ç»å¯¹ä¸èƒ½åŒæ—¶å‡ºç°åœ¨ remove_steps / update_steps / add_steps ä¸­ã€‚

âŒ é”™è¯¯ç¤ºä¾‹ï¼ˆå†²çªï¼‰ï¼š
{
  "remove_steps": ["step_2"],
  "update_steps": [{"id": "step_2", ...}]  // step_2 åŒæ—¶åœ¨ remove å’Œ update
}

âœ… æ­£ç¡®ç¤ºä¾‹ï¼ˆåªæ›´æ–°ï¼‰ï¼š
{
  "update_steps": [{"id": "step_2", "description": "æ–°æè¿°", ...}]
}

âœ… æ­£ç¡®ç¤ºä¾‹ï¼ˆåªåˆ é™¤ï¼‰ï¼š
{
  "remove_steps": ["step_2"]
}
```

### 2.3 å­—æ®µçº¦æŸå¼ºåŒ–

```jinja2
## update_steps å…è®¸çš„å­—æ®µï¼ˆåªæœ‰è¿™äº›ï¼ï¼‰

- id: string (å¿…é¡»)
- description: string
- dependencies: string[]
- tools_expected: string[]

ç¦æ­¢æ·»åŠ å…¶ä»–å­—æ®µï¼ˆå¦‚ language, pattern, status ç­‰ï¼‰ï¼
```

---

## 3. å®ç°æ­¥éª¤

- [x] 3.1 æ·»åŠ "å”¯ä¸€æ€§è§„åˆ™"å’Œæ­£è¯¯ç¤ºä¾‹ âœ…
- [x] 3.2 æ·»åŠ  update_steps å­—æ®µç™½åå• âœ…
- [x] 3.3 ç¼–è¯‘æ£€æŸ¥ï¼ˆJinja2 è¯­æ³•ï¼‰âœ… é€šè¿‡
- [x] 3.4 éªŒè¯æ±‡æŠ¥ âœ… å®Œæˆ

---

## 5. éªŒè¯ç»“æœ

### 5.1 Jinja2 è¯­æ³•æ£€æŸ¥
```
python -c "from jinja2 import ...; t = env.get_template('user/stage/replan.j2')"
# Jinja2 syntax OK âœ…
```

### 5.2 æ ¸å¿ƒå˜æ›´æ‘˜è¦

**æ–°å¢å†…å®¹**ï¼š
1. **å”¯ä¸€æ€§è§„åˆ™**ï¼šç”¨é†’ç›®æ ¼å¼ + æ­£è¯¯ç¤ºä¾‹è¯´æ˜å†²çªçº¦æŸ
2. **å­—æ®µç™½åå•**ï¼šæ˜ç¡® update_steps åªå…è®¸ id/description/dependencies/tools_expected
3. **æ ¼å¼ä¼˜åŒ–**ï¼šä½¿ç”¨ Markdown åˆ†èŠ‚ï¼Œæ›´æ˜“é˜…è¯»

### 5.3 é¢„æœŸæ”¶ç›Š
- å‡å°‘ LLM è¿”å›å†²çª JSON çš„æ¦‚ç‡
- å‡å°‘ LLM æ·»åŠ éæ³•å­—æ®µï¼ˆå¦‚ language, patternï¼‰çš„æ¦‚ç‡
- æé«˜ PlanPatch è§£ææˆåŠŸç‡

---

## 4. ä»£ç å˜æ›´æ¸…å•

| æ–‡ä»¶ | å˜æ›´ç±»å‹ | è¯´æ˜ |
| :--- | :--- | :--- |
| `src/clude_code/prompts/user/stage/replan.j2` | å¢å¼º | æ·»åŠ å†²çªçº¦æŸå’Œç¤ºä¾‹ |


