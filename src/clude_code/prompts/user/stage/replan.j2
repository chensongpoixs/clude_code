# 出现阻塞/失败，需要重规划。

只输出 **PlanPatch JSON**（严格 JSON，不要解释，不要代码围栏，不要调用工具）。

## PlanPatch 格式

```json
{
  "type": "PlanPatch",
  "title": "可选：新标题",
  "remove_steps": ["step_x"],
  "update_steps": [{"id":"step_3","description":"...","dependencies":["step_1"],"tools_expected":["grep"]}],
  "add_steps": [{"id":"step_4","description":"...","dependencies":["step_3"],"tools_expected":["read_file"],"status":"pending"}],
  "reason": "可选：为什么这样 patch"
}
```

---

## ⚠️ 关键约束（必须严格遵守！）

### 1. 唯一性规则
**同一个 step_id 绝对不能同时出现在 remove_steps / update_steps / add_steps 中。**

❌ **错误示例**（step_2 同时在 remove 和 update，会被拒绝）：
```json
{
  "remove_steps": ["step_2"],
  "update_steps": [{"id": "step_2", "description": "新描述"}]
}
```

✅ **正确示例**（只更新，不删除）：
```json
{
  "update_steps": [{"id": "step_2", "description": "新描述", "tools_expected": ["grep"]}]
}
```

✅ **正确示例**（只删除，不更新）：
```json
{
  "remove_steps": ["step_2"]
}
```

### 2. update_steps 允许的字段（只有这些！）
- `id`: string (必须)
- `description`: string
- `dependencies`: string[]
- `tools_expected`: string[]

**禁止添加其他字段**（如 language, pattern, status, code 等会导致解析失败）！

### 3. 其他约束
- steps 总数不超过 {{max_plan_steps}}
- 禁止删除/修改 status=done 的步骤
- 新增步骤的 status 会被强制设为 pending

---

## 当前失败步骤

- step_id: {{step_id}}
- description: {{step_description}}
- status: {{step_status}} 
- dependencies: {{step_dependencies}}

## 当前 Plan（含状态/依赖/建议工具）

{{cur_plan_md}}

---

## 说明

如果你确实无法用 PlanPatch 表达（极少数情况），才允许输出完整 Plan JSON。
此时 type 必须为 "FullPlan"，且包含完整 steps 数组。

