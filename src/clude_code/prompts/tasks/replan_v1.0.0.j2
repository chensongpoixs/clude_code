---
title: "Replan Prompt"
version: "1.0.0"
layer: "task"
purpose: "重规划：优先输出 PlanPatch JSON，必要时输出 FullPlan JSON"
---

# 出现阻塞/失败，需要重规划。

优先输出 PlanPatch JSON（严格 JSON，不要解释，不要调用工具）：
{
  "type": "PlanPatch",
  "title": "可选：新标题",
  "remove_steps": ["step_x"],
  "update_steps": [{"id":"step_3","description":"...","dependencies":["step_1"],"tools_expected":["grep"]}],
  "add_steps": [{"id":"step_4","description":"...","dependencies":["step_3"],"tools_expected":["read_file"],"status":"pending"}],
  "reason": "可选：为什么这样 patch"
}

# 约束：
- steps 总数不超过 {{ max_plan_steps }}
- 禁止删除/修改 status=done 的步骤
- 新增步骤的 status 会被强制设为 pending
- PlanPatch 内部不得冲突（同一步骤不能同时 remove 与 update）
- 禁止输出 ```，禁止输出除 JSON 外的任何内容

# 当前失败步骤：
- step_id={{ step_id }}
- description={{ step_description }}
- status={{ step_status }}
- dependencies={{ step_dependencies }}

# 当前 Plan（含状态/依赖/建议工具）：
{{ cur_plan_md }}


