<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1600 2400">
  <style>
    .box { fill: #e8f4f8; stroke: #2c5aa0; stroke-width: 2; }
    .diamond { fill: #fff4e6; stroke: #d97706; stroke-width: 2; }
    .start { fill: #d1fae5; stroke: #059669; stroke-width: 2; }
    .end { fill: #fee2e2; stroke: #dc2626; stroke-width: 2; }
    .loop { fill: #fef3c7; stroke: #f59e0b; stroke-width: 2; }
    .process { fill: #e0e7ff; stroke: #6366f1; stroke-width: 2; }
    .log { fill: #f3f4f6; stroke: #6b7280; stroke-width: 2; }
    .text { font-family: 'Microsoft YaHei', Arial, sans-serif; font-size: 12px; }
    .title { font-size: 20px; font-weight: bold; }
    .subtitle { font-size: 15px; font-weight: bold; }
    .note { font-size: 10px; fill: #6b7280; }
    @keyframes flow {
      0% { stroke-dashoffset: 0; }
      100% { stroke-dashoffset: 20; }
    }
    @keyframes highlight {
      0%, 100% { fill: #e8f4f8; }
      50% { fill: #fef3c7; }
    }
    .arrow { stroke: #1f2937; stroke-width: 2; fill: none; marker-end: url(#arrowhead); animation: flow 2s linear infinite; }
    .arrow-dashed { stroke: #dc2626; stroke-width: 2; fill: none; marker-end: url(#arrowhead-red); stroke-dasharray: 5,5; animation: flow 2s linear infinite; }
    .highlight { animation: highlight 2s ease-in-out infinite; }
  </style>
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#1f2937" />
    </marker>
    <marker id="arrowhead-red" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#dc2626" />
    </marker>
  </defs>
  
  <!-- 标题 -->
  <text x="800" y="40" text-anchor="middle" class="text title" fill="#1f2937">Agent 完整执行流程（ReAct 模式）</text>
  
  <!-- 阶段一：初始化 -->
  <rect x="50" y="60" width="1500" height="2" fill="#e5e7eb"/>
  <text x="800" y="90" text-anchor="middle" class="text subtitle" fill="#6366f1">【阶段一】初始化（AgentLoop.__init__）</text>
  
  <rect x="600" y="110" width="400" height="35" rx="5" class="start"/>
  <text x="800" y="133" text-anchor="middle" class="text">开始：创建 AgentLoop(cfg)</text>
  
  <rect x="600" y="160" width="400" height="35" rx="5" class="box"/>
  <text x="800" y="183" text-anchor="middle" class="text">初始化 LLM 客户端（llama.cpp HTTP）</text>
  
  <rect x="600" y="210" width="400" height="35" rx="5" class="box"/>
  <text x="800" y="233" text-anchor="middle" class="text">初始化工具集（LocalTools）</text>
  
  <rect x="600" y="260" width="400" height="35" rx="5" class="box"/>
  <text x="800" y="283" text-anchor="middle" class="text">初始化审计和追踪日志</text>
  
  <rect x="600" y="310" width="400" height="35" rx="5" class="box"/>
  <text x="800" y="333" text-anchor="middle" class="text">启动后台索引服务（LanceDB RAG）</text>
  
  <rect x="600" y="360" width="400" height="35" rx="5" class="box"/>
  <text x="800" y="383" text-anchor="middle" class="text">生成 Repo Map（ctags）</text>
  
  <rect x="600" y="410" width="400" height="35" rx="5" class="box"/>
  <text x="800" y="433" text-anchor="middle" class="text">构建系统提示词（System Prompt）</text>
  
  <rect x="600" y="460" width="400" height="35" rx="5" class="box"/>
  <text x="800" y="483" text-anchor="middle" class="text">初始化消息历史 [system]</text>
  
  <!-- 阶段二：用户输入处理 -->
  <rect x="50" y="520" width="1500" height="2" fill="#e5e7eb"/>
  <text x="800" y="550" text-anchor="middle" class="text subtitle" fill="#6366f1">【阶段二】用户输入处理（run_turn 开始）</text>
  
  <rect x="600" y="570" width="400" height="35" rx="5" class="process"/>
  <text x="800" y="593" text-anchor="middle" class="text">接收用户输入（user_text）</text>
  
  <rect x="600" y="620" width="400" height="35" rx="5" class="box"/>
  <text x="800" y="643" text-anchor="middle" class="text">生成 trace_id = hash(session_id + user_text)</text>
  
  <rect x="600" y="670" width="400" height="35" rx="5" class="box"/>
  <text x="800" y="693" text-anchor="middle" class="text">提取关键词（用于语义窗口采样）</text>
  
  <rect x="600" y="720" width="400" height="35" rx="5" class="log"/>
  <text x="800" y="743" text-anchor="middle" class="text">记录用户消息到审计日志</text>
  
  <rect x="600" y="770" width="400" height="35" rx="5" class="box"/>
  <text x="800" y="793" text-anchor="middle" class="text">添加到消息历史 [user]</text>
  
  <rect x="600" y="820" width="400" height="35" rx="5" class="box"/>
  <text x="800" y="843" text-anchor="middle" class="text">裁剪历史（_trim_history，max=30）</text>
  
  <!-- 阶段三：ReAct 循环 -->
  <rect x="50" y="880" width="1500" height="2" fill="#e5e7eb"/>
  <text x="800" y="910" text-anchor="middle" class="text subtitle" fill="#6366f1">【阶段三】ReAct 循环（最多 20 次迭代）</text>
  
  <rect x="500" y="930" width="600" height="40" rx="5" class="loop"/>
  <text x="800" y="955" text-anchor="middle" class="text">循环开始：for iteration in range(20)</text>
  
  <!-- LLM 请求 -->
  <rect x="600" y="990" width="400" height="35" rx="5" class="log"/>
  <text x="800" y="1013" text-anchor="middle" class="text">记录请求参数到文件（仅文件日志）</text>
  
  <rect x="600" y="1040" width="400" height="35" rx="5" class="box"/>
  <text x="800" y="1063" text-anchor="middle" class="text">调用 LLM.chat(messages)</text>
  
  <rect x="600" y="1090" width="400" height="35" rx="5" class="box"/>
  <text x="800" y="1113" text-anchor="middle" class="text">检测复读字符异常（stuttering）</text>
  
  <rect x="600" y="1140" width="400" height="35" rx="5" class="log"/>
  <text x="800" y="1163" text-anchor="middle" class="text">记录响应数据到文件（仅文件日志）</text>
  
  <rect x="600" y="1190" width="400" height="35" rx="5" class="box"/>
  <text x="800" y="1213" text-anchor="middle" class="text">解析工具调用（_try_parse_tool_call）</text>
  
  <!-- 判断分支 -->
  <polygon points="800,1240 870,1265 800,1290 730,1265" class="diamond"/>
  <text x="800" y="1270" text-anchor="middle" class="text">有工具调用?</text>
  
  <!-- 无工具调用分支（左侧） -->
  <rect x="100" y="1310" width="300" height="35" rx="5" class="box"/>
  <text x="250" y="1333" text-anchor="middle" class="text">保存完整 assistant 消息</text>
  
  <rect x="100" y="1360" width="300" height="35" rx="5" class="log"/>
  <text x="250" y="1383" text-anchor="middle" class="text">记录审计日志（assistant_text）</text>
  
  <rect x="100" y="1410" width="300" height="35" rx="5" class="box"/>
  <text x="250" y="1433" text-anchor="middle" class="text">裁剪历史</text>
  
  <rect x="100" y="1460" width="300" height="50" rx="5" class="end"/>
  <text x="250" y="1485" text-anchor="middle" class="text">返回 AgentTurn</text>
  <text x="250" y="1500" text-anchor="middle" class="text">（最终文本）</text>
  
  <!-- 有工具调用分支（右侧） -->
  <rect x="1200" y="1310" width="300" height="35" rx="5" class="box"/>
  <text x="1350" y="1333" text-anchor="middle" class="text">提取工具名称和参数</text>
  
  <rect x="1200" y="1360" width="300" height="35" rx="5" class="box"/>
  <text x="1350" y="1383" text-anchor="middle" class="text">保存 clean JSON 到历史</text>
  
  <rect x="1200" y="1410" width="300" height="35" rx="5" class="box"/>
  <text x="1350" y="1433" text-anchor="middle" class="text">裁剪历史</text>
  
  <!-- 策略检查：用户确认 -->
  <polygon points="1350,1460 1420,1485 1350,1510 1280,1485" class="diamond"/>
  <text x="1350" y="1490" text-anchor="middle" class="text">需要确认?</text>
  <text x="1350" y="1505" text-anchor="middle" class="note">（写文件/执行命令）</text>
  
  <rect x="1200" y="1530" width="300" height="35" rx="5" class="box"/>
  <text x="1350" y="1553" text-anchor="middle" class="text">用户确认/拒绝</text>
  
  <polygon points="1350,1580 1420,1605 1350,1630 1280,1605" class="diamond"/>
  <text x="1350" y="1610" text-anchor="middle" class="text">用户允许?</text>
  
  <!-- 策略检查：命令黑名单 -->
  <polygon points="1350,1660 1420,1685 1350,1710 1280,1685" class="diamond"/>
  <text x="1350" y="1690" text-anchor="middle" class="text">策略检查</text>
  <text x="1350" y="1705" text-anchor="middle" class="note">（命令黑名单）</text>
  
  <polygon points="1350,1730 1420,1755 1350,1780 1280,1755" class="diamond"/>
  <text x="1350" y="1760" text-anchor="middle" class="text">策略允许?</text>
  
  <!-- 工具执行 -->
  <rect x="1200" y="1800" width="300" height="35" rx="5" class="box"/>
  <text x="1350" y="1823" text-anchor="middle" class="text">执行工具（_dispatch_tool）</text>
  
  <rect x="1200" y="1850" width="300" height="35" rx="5" class="box"/>
  <text x="1350" y="1873" text-anchor="middle" class="text">结构化反馈转换</text>
  <text x="1350" y="1888" text-anchor="middle" class="note">（语义窗口采样）</text>
  
  <rect x="1200" y="1900" width="300" height="35" rx="5" class="box"/>
  <text x="1350" y="1923" text-anchor="middle" class="text">回喂结果给 LLM [user]</text>
  
  <rect x="1200" y="1950" width="300" height="35" rx="5" class="log"/>
  <text x="1350" y="1973" text-anchor="middle" class="text">记录审计日志（tool_call）</text>
  
  <rect x="1200" y="2000" width="300" height="35" rx="5" class="box"/>
  <text x="1350" y="2023" text-anchor="middle" class="text">裁剪历史</text>
  
  <!-- 循环返回 -->
  <path d="M 1350,2040 L 1350,2060 L 800,2060 L 800,970" class="arrow" stroke-dasharray="5,5"/>
  <text x="1075" y="2055" class="text" fill="#6b7280" font-size="11">继续循环</text>
  
  <!-- 拒绝分支 -->
  <path d="M 1280,1485 L 800,1485 L 800,970" class="arrow-dashed"/>
  <text x="1040" y="1480" class="text" fill="#dc2626" font-size="11">用户拒绝</text>
  
  <path d="M 1280,1605 L 800,1605 L 800,970" class="arrow-dashed"/>
  <text x="1040" y="1600" class="text" fill="#dc2626" font-size="11">用户拒绝</text>
  
  <path d="M 1280,1755 L 800,1755 L 800,970" class="arrow-dashed"/>
  <text x="1040" y="1750" class="text" fill="#dc2626" font-size="11">策略拒绝</text>
  
  <!-- 达到最大次数 -->
  <rect x="600" y="2080" width="400" height="50" rx="5" class="end"/>
  <text x="800" y="2105" text-anchor="middle" class="text">达到最大迭代次数（20）</text>
  <text x="800" y="2120" text-anchor="middle" class="text">返回停止消息</text>
  
  <!-- 箭头连接 -->
  <path d="M 800,145 L 800,160" class="arrow"/>
  <path d="M 800,195 L 800,210" class="arrow"/>
  <path d="M 800,245 L 800,260" class="arrow"/>
  <path d="M 800,295 L 800,310" class="arrow"/>
  <path d="M 800,345 L 800,360" class="arrow"/>
  <path d="M 800,395 L 800,410" class="arrow"/>
  <path d="M 800,445 L 800,460" class="arrow"/>
  <path d="M 800,495 L 800,570" class="arrow"/>
  <path d="M 800,605 L 800,620" class="arrow"/>
  <path d="M 800,655 L 800,670" class="arrow"/>
  <path d="M 800,705 L 800,720" class="arrow"/>
  <path d="M 800,755 L 800,770" class="arrow"/>
  <path d="M 800,805 L 800,820" class="arrow"/>
  <path d="M 800,855 L 800,930" class="arrow"/>
  <path d="M 800,970 L 800,990" class="arrow"/>
  <path d="M 800,1025 L 800,1040" class="arrow"/>
  <path d="M 800,1075 L 800,1090" class="arrow"/>
  <path d="M 800,1125 L 800,1140" class="arrow"/>
  <path d="M 800,1175 L 800,1190" class="arrow"/>
  <path d="M 800,1225 L 800,1240" class="arrow"/>
  <path d="M 730,1265 L 250,1265 L 250,1310" class="arrow"/>
  <path d="M 870,1265 L 1350,1265 L 1350,1310" class="arrow"/>
  <path d="M 250,1345 L 250,1360" class="arrow"/>
  <path d="M 250,1395 L 250,1410" class="arrow"/>
  <path d="M 250,1445 L 250,1460" class="arrow"/>
  <path d="M 1350,1345 L 1350,1360" class="arrow"/>
  <path d="M 1350,1395 L 1350,1410" class="arrow"/>
  <path d="M 1350,1445 L 1350,1460" class="arrow"/>
  <path d="M 1280,1485 L 1200,1485 L 1200,1530" class="arrow"/>
  <path d="M 1350,1510 L 1350,1530" class="arrow"/>
  <path d="M 1280,1605 L 1200,1605 L 1200,1530" class="arrow"/>
  <path d="M 1350,1585 L 1350,1660" class="arrow"/>
  <path d="M 1280,1685 L 1200,1685 L 1200,1800" class="arrow"/>
  <path d="M 1350,1710 L 1350,1730" class="arrow"/>
  <path d="M 1280,1755 L 1200,1755 L 1200,1800" class="arrow"/>
  <path d="M 1350,1785 L 1350,1800" class="arrow"/>
  <path d="M 1350,1835 L 1350,1850" class="arrow"/>
  <path d="M 1350,1885 L 1350,1900" class="arrow"/>
  <path d="M 1350,1935 L 1350,1950" class="arrow"/>
  <path d="M 1350,1985 L 1350,2000" class="arrow"/>
  <path d="M 800,2130 L 800,2145" class="arrow"/>
  
  <!-- 图例 -->
  <rect x="50" y="2200" width="200" height="120" fill="#f9fafb" stroke="#e5e7eb" stroke-width="1"/>
  <text x="150" y="2220" text-anchor="middle" class="text" font-weight="bold">图例</text>
  <rect x="60" y="2230" width="30" height="20" class="start"/>
  <text x="100" y="2245" class="text" font-size="11">开始/结束</text>
  <rect x="60" y="2255" width="30" height="20" class="box"/>
  <text x="100" y="2270" class="text" font-size="11">处理步骤</text>
  <rect x="60" y="2280" width="30" height="20" class="diamond"/>
  <text x="100" y="2295" class="text" font-size="11">判断分支</text>
  <rect x="60" y="2305" width="30" height="20" class="loop"/>
  <text x="100" y="2320" class="text" font-size="11">循环</text>
  <rect x="60" y="2330" width="30" height="20" class="log"/>
  <text x="100" y="2345" class="text" font-size="11">日志记录</text>
  
  <text x="800" y="2370" class="text" font-size="11" fill="#6b7280">
    说明：红色虚线箭头表示拒绝分支，会跳过工具执行并继续循环；蓝色虚线箭头表示循环返回
  </text>
</svg>
