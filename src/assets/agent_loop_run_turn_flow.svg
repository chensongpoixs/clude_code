<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 1200">
  <style>
    .box { fill: #e8f4f8; stroke: #2c5aa0; stroke-width: 2; }
    .diamond { fill: #fff4e6; stroke: #d97706; stroke-width: 2; }
    .start { fill: #d1fae5; stroke: #059669; stroke-width: 2; }
    .end { fill: #fee2e2; stroke: #dc2626; stroke-width: 2; }
    .loop { fill: #fef3c7; stroke: #f59e0b; stroke-width: 2; }
    .text { font-family: 'Microsoft YaHei', Arial, sans-serif; font-size: 12px; }
    .title { font-size: 16px; font-weight: bold; }
    @keyframes flow {
      0% { stroke-dashoffset: 0; }
      100% { stroke-dashoffset: 20; }
    }
    .arrow { stroke: #1f2937; stroke-width: 2; fill: none; marker-end: url(#arrowhead); animation: flow 1s linear infinite; }
  </style>
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#1f2937" />
    </marker>
  </defs>
  
  <text x="450" y="30" text-anchor="middle" class="text title">AgentLoop.run_turn 核心循环流程图</text>
  
  <rect x="350" y="60" width="200" height="40" rx="5" class="start"/>
  <text x="450" y="85" text-anchor="middle" class="text">开始：接收 user_text</text>
  
  <rect x="350" y="120" width="200" height="40" rx="5" class="box"/>
  <text x="450" y="145" text-anchor="middle" class="text">生成 trace_id</text>
  
  <rect x="350" y="180" width="200" height="40" rx="5" class="box"/>
  <text x="450" y="205" text-anchor="middle" class="text">提取关键词（语义采样）</text>
  
  <rect x="350" y="240" width="200" height="40" rx="5" class="box"/>
  <text x="450" y="265" text-anchor="middle" class="text">记录 user_message 事件</text>
  
  <rect x="350" y="300" width="200" height="40" rx="5" class="box"/>
  <text x="450" y="325" text-anchor="middle" class="text">添加到 messages</text>
  
  <rect x="350" y="360" width="200" height="40" rx="5" class="box"/>
  <text x="450" y="385" text-anchor="middle" class="text">_trim_history()</text>
  
  <!-- 循环开始 -->
  <rect x="300" y="420" width="300" height="40" rx="5" class="loop"/>
  <text x="450" y="445" text-anchor="middle" class="text">循环：最多 20 次工具调用</text>
  
  <rect x="350" y="480" width="200" height="40" rx="5" class="box"/>
  <text x="450" y="505" text-anchor="middle" class="text">调用 LLM.chat()</text>
  
  <rect x="350" y="540" width="200" height="40" rx="5" class="box"/>
  <text x="450" y="565" text-anchor="middle" class="text">检测复读字符</text>
  
  <rect x="350" y="600" width="200" height="40" rx="5" class="box"/>
  <text x="450" y="625" text-anchor="middle" class="text">_try_parse_tool_call()</text>
  
  <polygon points="450,660 500,680 450,700 400,680" class="diamond"/>
  <text x="450" y="685" text-anchor="middle" class="text">有工具调用?</text>
  
  <!-- 无工具调用分支 -->
  <rect x="100" y="720" width="200" height="40" rx="5" class="box"/>
  <text x="200" y="745" text-anchor="middle" class="text">保存 assistant 消息</text>
  
  <rect x="100" y="780" width="200" height="40" rx="5" class="end"/>
  <text x="200" y="805" text-anchor="middle" class="text">返回最终文本</text>
  
  <!-- 有工具调用分支 -->
  <rect x="600" y="720" width="200" height="40" rx="5" class="box"/>
  <text x="700" y="745" text-anchor="middle" class="text">保存 clean JSON</text>
  
  <polygon points="700,780 750,800 700,820 650,800" class="diamond"/>
  <text x="700" y="805" text-anchor="middle" class="text">需要确认?</text>
  
  <rect x="600" y="840" width="200" height="40" rx="5" class="box"/>
  <text x="700" y="865" text-anchor="middle" class="text">用户确认/拒绝</text>
  
  <polygon points="700,900 750,920 700,940 650,920" class="diamond"/>
  <text x="700" y="925" text-anchor="middle" class="text">策略检查</text>
  
  <rect x="600" y="960" width="200" height="40" rx="5" class="box"/>
  <text x="700" y="985" text-anchor="middle" class="text">_dispatch_tool()</text>
  
  <rect x="600" y="1020" width="200" height="40" rx="5" class="box"/>
  <text x="700" y="1045" text-anchor="middle" class="text">回喂结果给 LLM</text>
  
  <rect x="600" y="1080" width="200" height="40" rx="5" class="box"/>
  <text x="700" y="1105" text-anchor="middle" class="text">_trim_history()</text>
  
  <!-- 循环返回 -->
  <path d="M 700,1120 L 700,1140 L 450,1140 L 450,460" class="arrow" stroke-dasharray="5,5"/>
  
  <!-- 达到最大次数 -->
  <rect x="350" y="1140" width="200" height="40" rx="5" class="end"/>
  <text x="450" y="1165" text-anchor="middle" class="text">返回停止消息</text>
  
  <!-- 箭头 -->
  <path d="M 450,100 L 450,120" class="arrow"/>
  <path d="M 450,160 L 450,180" class="arrow"/>
  <path d="M 450,220 L 450,240" class="arrow"/>
  <path d="M 450,280 L 450,300" class="arrow"/>
  <path d="M 450,340 L 450,360" class="arrow"/>
  <path d="M 450,400 L 450,420" class="arrow"/>
  <path d="M 450,460 L 450,480" class="arrow"/>
  <path d="M 450,520 L 450,540" class="arrow"/>
  <path d="M 450,580 L 450,600" class="arrow"/>
  <path d="M 450,640 L 450,660" class="arrow"/>
  <path d="M 400,680 L 200,680 L 200,720" class="arrow"/>
  <path d="M 500,680 L 700,680 L 700,720" class="arrow"/>
  <path d="M 200,760 L 200,780" class="arrow"/>
  <path d="M 700,760 L 700,780" class="arrow"/>
  <path d="M 650,800 L 600,800 L 600,840" class="arrow"/>
  <path d="M 700,880 L 700,900" class="arrow"/>
  <path d="M 650,920 L 600,920 L 600,960" class="arrow"/>
  <path d="M 700,1000 L 700,1020" class="arrow"/>
  <path d="M 700,1060 L 700,1080" class="arrow"/>
  <path d="M 700,1120 L 700,1140" class="arrow"/>
  <path d="M 450,1140 L 450,1160" class="arrow"/>
</svg>

