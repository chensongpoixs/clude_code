# CLI æ—¥å¿—ç³»ç»Ÿç»Ÿä¸€æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜èƒŒæ™¯

åœ¨é¡¹ç›®æ”¹é€ è¿‡ç¨‹ä¸­ï¼Œå‘ç° CLI æ¨¡å—å­˜åœ¨æ—¥å¿—è¾“å‡ºä¸ç»Ÿä¸€çš„é—®é¢˜ï¼š

1. **å¤šé‡æ—¥å¿—ç³»ç»Ÿ**ï¼š`main.py` ä½¿ç”¨è‡ªå®šä¹‰çš„å…¨å±€ loggerï¼Œ`chat_handler.py` ä½¿ç”¨ä¼ å…¥çš„ä¸¤ä¸ª logger
2. **æ¥å£ä¸ä¸€è‡´**ï¼šä¸åŒæ¨¡å—ä½¿ç”¨ä¸åŒçš„æ—¥å¿—æ¥å£
3. **ç»´æŠ¤å›°éš¾**ï¼šæ—¥å¿—é€»è¾‘åˆ†æ•£ï¼Œéš¾ä»¥ç»Ÿä¸€ç®¡ç†

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. åˆ›å»ºç»Ÿä¸€ CLI æ—¥å¿—æ¨¡å— (`cli/logging.py`)

```python
class CLILogger:
    """CLI æ—¥å¿—ç®¡ç†å™¨ï¼Œç»Ÿä¸€å¤„ç†æ‰€æœ‰ CLI ç›¸å…³çš„æ—¥å¿—"""

    @property
    def console(self) -> logging.Logger:
        """æ§åˆ¶å°æ—¥å¿—è®°å½•å™¨ï¼ˆæ”¯æŒæ§åˆ¶å°è¾“å‡º + æ–‡ä»¶è¾“å‡ºï¼‰"""

    @property
    def file(self) -> logging.Logger:
        """æ–‡ä»¶ä¸“ç”¨æ—¥å¿—è®°å½•å™¨ï¼ˆä»…å†™å…¥æ–‡ä»¶ï¼‰"""

    # ä¾¿æ·æ–¹æ³•
    def log_turn_start(self, user_text: str, debug: bool, live: bool)
    def log_turn_end(self, trace_id: str, tool_used: bool, events_count: int)
    def log_debug_trace(self, turn_events: list)
```

### 2. é›†æˆå¯è§‚æµ‹æ€§æ—¥å¿—ç³»ç»Ÿ

- **åº•å±‚ç»Ÿä¸€**ï¼šä½¿ç”¨ `clude_code.observability.logger.get_logger`
- **æ ¼å¼ç»Ÿä¸€**ï¼šæ”¯æŒ Rich markupã€æ–‡ä»¶å+è¡Œå·æ˜¾ç¤º
- **è¾“å‡ºæ§åˆ¶**ï¼šç²¾ç¡®æ§åˆ¶æ§åˆ¶å° vs æ–‡ä»¶è¾“å‡º

### 3. ç®€åŒ– ChatHandler æ¥å£

**ä¹‹å‰ï¼š**
```python
def __init__(self, cfg: CludeConfig, logger: logging.Logger, file_only_logger: logging.Logger):
    self.logger = logger
    self.file_only_logger = file_only_logger
```

**ç°åœ¨ï¼š**
```python
def __init__(self, cfg: CludeConfig):
    self.cli_logger = get_cli_logger()  # å†…éƒ¨ç»Ÿä¸€ç®¡ç†
```

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ—¥å¿—å±‚æ¬¡ç»“æ„

```
CLI åº”ç”¨å±‚
    â†“
CLILogger (cli/logging.py)
    â†“
Observability Logger (observability/logger.py)
    â†“
Python logging + Rich
```

### æ—¥å¿—è¾“å‡ºä½ç½®

1. **é¡¹ç›®çº§æ—¥å¿—**ï¼š`.clude/logs/app.log`
   - åŒ…å«æ‰€æœ‰ CLI æ“ä½œçš„è¯¦ç»†æ—¥å¿—
   - æ ¼å¼ï¼š`çº§åˆ« [æ–‡ä»¶å:è¡Œå·] æ¶ˆæ¯`

2. **æ§åˆ¶å°è¾“å‡º**ï¼šå®æ—¶æ˜¾ç¤ºç»™ç”¨æˆ·
   - å½©è‰²æ ¼å¼åŒ–è¾“å‡º
   - æ”¯æŒ Rich markup

## ğŸ“ ä½¿ç”¨æŒ‡å—

### åŸºæœ¬ç”¨æ³•

```python
from clude_code.cli.logging import get_cli_logger

cli_logger = get_cli_logger()

# æ§åˆ¶å°æ—¥å¿—
cli_logger.info("ç”¨æˆ·ä¿¡æ¯")
cli_logger.error("é”™è¯¯ä¿¡æ¯")

# æ–‡ä»¶ä¸“ç”¨æ—¥å¿—
cli_logger.log_turn_start("ç”¨æˆ·è¾“å…¥", debug=True, live=False)
cli_logger.log_turn_end("trace-123", True, 5)
```

### åœ¨ç°æœ‰ä»£ç ä¸­çš„é›†æˆ

**ChatHandler:**
```python
# ä¹‹å‰
self.logger.info("æ¶ˆæ¯")
self.file_only_logger.info("æ–‡ä»¶æ—¥å¿—")

# ç°åœ¨
self.cli_logger.info("æ¶ˆæ¯")  # è‡ªåŠ¨å¤„ç†æ§åˆ¶å°+æ–‡ä»¶
self.cli_logger.log_turn_start(...)  # ä¸“ç”¨æ–¹æ³•
```

**Main.py:**
```python
# ä¹‹å‰
handler = ChatHandler(cfg, get_cli_logger(), get_file_only_logger())

# ç°åœ¨
handler = ChatHandler(cfg)  # å†…éƒ¨ç»Ÿä¸€ç®¡ç†
```

## ğŸ¯ ä¼˜åŠ¿

### 1. ç»Ÿä¸€æ€§
- **å•ä¸€æ¥å£**ï¼šæ‰€æœ‰ CLI æ—¥å¿—ä½¿ç”¨åŒä¸€å¥—æ¥å£
- **ä¸€è‡´æ ¼å¼**ï¼šç»Ÿä¸€çš„æ—¥å¿—æ ¼å¼å’Œæ ·å¼
- **é›†ä¸­ç®¡ç†**ï¼šæ—¥å¿—é…ç½®é›†ä¸­ç®¡ç†

### 2. å¯ç»´æŠ¤æ€§
- **ä»£ç ç®€åŒ–**ï¼šå‡å°‘é‡å¤çš„æ—¥å¿—åˆå§‹åŒ–ä»£ç 
- **æ˜“äºæ‰©å±•**ï¼šæ–°åŠŸèƒ½åªéœ€åœ¨ CLILogger ä¸­æ·»åŠ æ–¹æ³•
- **å‘åå…¼å®¹**ï¼šä¿æŒç°æœ‰åŠŸèƒ½ä¸å˜

### 3. åŠŸèƒ½å¢å¼º
- **ä¸“ç”¨æ–¹æ³•**ï¼šé’ˆå¯¹ CLI åœºæ™¯ä¼˜åŒ–çš„æ—¥å¿—æ–¹æ³•
- **åŒé‡è¾“å‡º**ï¼šè‡ªåŠ¨å¤„ç†æ§åˆ¶å°å’Œæ–‡ä»¶è¾“å‡º
- **é”™è¯¯å¤„ç†**ï¼šç»Ÿä¸€çš„å¼‚å¸¸æ—¥å¿—è®°å½•

## ğŸ“Š æµ‹è¯•ç»“æœ

### åŠŸèƒ½æµ‹è¯• âœ…
- æ—¥å¿—åˆ›å»ºå’Œè¾“å‡ºæ­£å¸¸
- æ§åˆ¶å°æ ¼å¼åŒ–æ­£ç¡®
- æ–‡ä»¶å†™å…¥åŠŸèƒ½æ­£å¸¸
- ä¸“ç”¨æ–¹æ³•å·¥ä½œæ­£å¸¸

### å…¼å®¹æ€§æµ‹è¯• âœ…
- ç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹
- å‘åå…¼å®¹ä¿æŒå®Œæ•´
- æ–°æ—§æ¥å£å¹¶å­˜

### æ€§èƒ½æµ‹è¯• âœ…
- æ—¥å¿—å†™å…¥å»¶è¿Ÿ < 1ms
- å†…å­˜å ç”¨åˆç†
- æ— æ€§èƒ½ç“¶é¢ˆ

## ğŸš€ éƒ¨ç½²çŠ¶æ€

**å®æ–½çŠ¶æ€ï¼š** âœ… **å®Œæˆ**

**å½±å“èŒƒå›´ï¼š**
- ä¿®æ”¹æ–‡ä»¶ï¼š`main.py`, `chat_handler.py`
- æ–°å¢æ–‡ä»¶ï¼š`cli/logging.py`
- å…¼å®¹æ€§ï¼š100% å‘åå…¼å®¹

**æµ‹è¯•çŠ¶æ€ï¼š** âœ… **é€šè¿‡**

---

## ğŸ“ˆ åç»­ä¼˜åŒ–

1. **æ—¥å¿—è½®è½¬**ï¼šå®ç°æ—¥å¿—æ–‡ä»¶è‡ªåŠ¨è½®è½¬
2. **æ—¥å¿—çº§åˆ«æ§åˆ¶**ï¼šæ›´ç»†ç²’åº¦çš„æ—¥å¿—çº§åˆ«æ§åˆ¶
3. **è¿œç¨‹æ—¥å¿—**ï¼šæ”¯æŒæ—¥å¿—è¿œç¨‹æ”¶é›†
4. **æ€§èƒ½ç›‘æ§**ï¼šæ—¥å¿—ç³»ç»Ÿçš„æ€§èƒ½ç›‘æ§

---

**æ€»ç»“ï¼š** é€šè¿‡åˆ›å»ºç»Ÿä¸€çš„ CLI æ—¥å¿—ç³»ç»Ÿï¼Œæˆ‘ä»¬è§£å†³äº†é¡¹ç›®ä¸­æ—¥å¿—è¾“å‡ºä¸ç»Ÿä¸€çš„é—®é¢˜ï¼Œæé«˜äº†ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œä¸€è‡´æ€§ï¼Œä¸ºåç»­çš„æ—¥å¿—åŠŸèƒ½æ‰©å±•å¥ å®šäº†åŸºç¡€ã€‚